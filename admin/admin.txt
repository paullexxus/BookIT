C:\wamp64\www\BookIT\admin\admin_dashboard.php
<?php
// superadmin/index.php - MAIN DASHBOARD
// Pull summary data for charts from the database
include_once '../config/db.php';
include '../includes/session.php';
include '../includes/functions.php';
checkRole(['admin']);

// Additional statistics using your existing functions - UPDATED
$totalUsers = 0;
$totalBranches = 0;
$totalUnits = 0;
$totalReservations = 0;
$totalRevenue = 0;

// Total Users (Host & Renters) - Only active
$result = $conn->query("SELECT COUNT(*) as cnt FROM users WHERE is_active = 1");
if ($result && $row = $result->fetch_assoc()) $totalUsers = (int)$row['cnt'];

// Total Branches - Only active
$result = $conn->query("SELECT COUNT(*) as cnt FROM branches WHERE is_active = 1");
if ($result && $row = $result->fetch_assoc()) $totalBranches = (int)$row['cnt'];

// Total Units (Listings) - Only from active branches
$result = $conn->query("SELECT COUNT(*) as cnt FROM units u 
                       JOIN branches b ON u.branch_id = b.branch_id 
                       WHERE b.is_active = 1");
if ($result && $row = $result->fetch_assoc()) $totalUnits = (int)$row['cnt'];

// Total Reservations - Only from active branches
$result = $conn->query("SELECT COUNT(*) as cnt FROM reservations r 
                       JOIN branches b ON r.branch_id = b.branch_id 
                       WHERE b.is_active = 1");
if ($result && $row = $result->fetch_assoc()) $totalReservations = (int)$row['cnt'];

// Total Revenue (from reservations) - Only from active branches
$result = $conn->query("SELECT SUM(r.total_amount) as total FROM reservations r 
                       JOIN branches b ON r.branch_id = b.branch_id 
                       WHERE r.status IN ('confirmed', 'checked_in', 'completed') 
                       AND b.is_active = 1");
if ($result && $row = $result->fetch_assoc()) $totalRevenue = (float)$row['total'];

// CORRECTED: Booking Rate Calculation - Number of unique booked units from ACTIVE branches
$result = $conn->query("SELECT COUNT(DISTINCT r.unit_id) as booked_units 
                       FROM reservations r 
                       JOIN branches b ON r.branch_id = b.branch_id 
                       WHERE r.status IN ('confirmed', 'checked_in') 
                       AND b.is_active = 1");
$bookedUnits = 0;
if ($result && $row = $result->fetch_assoc()) $bookedUnits = (int)$row['booked_units'];

// Calculate booking rate (max 100%) - Only from active branches
$bookingRate = $totalUnits > 0 ? min(round(($bookedUnits / $totalUnits) * 100, 1), 100) : 0;

// Reservation Status Breakdown
$reservationStats = [
    'pending' => 0,
    'confirmed' => 0,
    'checked_in' => 0,
    'cancelled' => 0,
    'completed' => 0
];

$result = $conn->query("SELECT status, COUNT(*) as cnt FROM reservations GROUP BY status");
if ($result) {
    while ($row = $result->fetch_assoc()) {
        $status = $row['status'] ?? 'unknown';
        if (isset($reservationStats[$status])) {
            $reservationStats[$status] = (int)$row['cnt'];
        }
    }
}

// User Role Breakdown
$userStats = [
    'admin' => 0,
    'host' => 0,
    'renter' => 0,
    'manager' => 0  // For compatibility
];

$result = $conn->query("SELECT role, COUNT(*) as cnt FROM users GROUP BY role");
if ($result) {
    while ($row = $result->fetch_assoc()) {
        $userStats[$row['role']] = (int)$row['cnt'];
    }
}

// Get recent reservations for the activity feed
$recentReservations = get_multiple_results(
    "SELECT r.*, u.full_name, un.unit_number, b.branch_name 
     FROM reservations r 
     JOIN users u ON r.user_id = u.user_id 
     JOIN units un ON r.unit_id = un.unit_id 
     JOIN branches b ON r.branch_id = b.branch_id 
     ORDER BY r.created_at DESC LIMIT 5"
);

// Monthly Revenue Data for Chart
$monthlyRevenue = fetch_pairs($conn, 
    "SELECT DATE_FORMAT(created_at, '%Y-%m') as month, 
            SUM(total_amount) as revenue 
     FROM reservations 
     WHERE status IN ('confirmed', 'checked_in', 'completed')
     GROUP BY DATE_FORMAT(created_at, '%Y-%m')
     ORDER BY month DESC LIMIT 6", 
    'month', 'revenue'
);

// Monthly Revenue Data for current year
$monthly_revenue = get_multiple_results("
    SELECT 
        DATE_FORMAT(created_at, '%b') as month,
        MONTH(created_at) as month_num,
        COALESCE(SUM(total_amount), 0) as revenue
    FROM reservations
    WHERE YEAR(created_at) = YEAR(CURDATE())
    AND status IN ('confirmed', 'checked_in', 'completed')
    AND payment_status = 'completed'
    GROUP BY MONTH(created_at), DATE_FORMAT(created_at, '%b')
    ORDER BY MONTH(created_at)
");

// Yearly Revenue Data for history
$yearly_revenue = get_multiple_results("
    SELECT 
        YEAR(created_at) as year,
        COALESCE(SUM(total_amount), 0) as revenue
    FROM reservations
    WHERE status IN ('confirmed', 'checked_in', 'completed')
    AND payment_status = 'completed'
    GROUP BY YEAR(created_at)
    ORDER BY YEAR(created_at) DESC
");

// Last 12 months revenue data for detailed chart
$last_12_months_revenue = get_multiple_results("
    SELECT 
        DATE_FORMAT(created_at, '%Y-%m') as month_year,
        DATE_FORMAT(created_at, '%b %y') as month_label,
        COALESCE(SUM(total_amount), 0) as revenue
    FROM reservations
    WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)
    AND status IN ('confirmed', 'checked_in', 'completed')
    AND payment_status = 'completed'
    GROUP BY DATE_FORMAT(created_at, '%Y-%m'), DATE_FORMAT(created_at, '%b %y')
    ORDER BY DATE_FORMAT(created_at, '%Y-%m')
");

// Reservation Status for Pie Chart
$reservationsStatus = fetch_pairs($conn, 
    "SELECT COALESCE(status,'Unknown') AS status, COUNT(*) AS cnt 
     FROM reservations 
     GROUP BY status", 
    'status', 'cnt'
);

// Units by Type for Chart
$unitsByType = fetch_pairs($conn, 
    "SELECT COALESCE(unit_type,'Unknown') AS type, COUNT(*) AS cnt 
     FROM units 
     GROUP BY unit_type 
     ORDER BY cnt DESC", 
    'type', 'cnt'
);

// Users by Role for Chart
$usersByRole = fetch_pairs($conn, 
    "SELECT COALESCE(role,'Unknown') AS role, COUNT(*) AS cnt 
     FROM users 
     GROUP BY role 
     ORDER BY cnt DESC", 
    'role', 'cnt'
);

// JSON encode for front-end
$monthlyRevenueJson = json_encode($monthlyRevenue);
$reservationsStatusJson = json_encode($reservationsStatus);
$unitsByTypeJson = json_encode($unitsByType);
$usersByRoleJson = json_encode($usersByRole);
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="../assets/css/admin/admin_dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container-fluid">
        <div class="row">
  <?php include '../includes/sidebar.php'; ?>

  <!-- =================== DASHBOARD CONTENT =================== -->
  <main class="content">
    <div class="dashboard-header">
      <h1>Admin Dashboard Overview</h1>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-number"><?php echo $totalBranches; ?></div>
        <div class="stat-label">Total Branches</div>
        <i class="fas fa-code-branch fa-2x stat-icon"></i>
        <button class="stat-action-btn" onclick="openModal('branchesModal')">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
      <div class="stat-card">
        <div class="stat-number"><?php echo $totalUnits; ?></div>
        <div class="stat-label">Total Units</div>
        <i class="fas fa-home fa-2x stat-icon"></i>
        <button class="stat-action-btn" onclick="openModal('unitsModal')">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
      <div class="stat-card">
        <div class="stat-number"><?php echo $totalReservations; ?></div>
        <div class="stat-label">Total Reservations</div>
        <i class="fas fa-calendar-check fa-2x stat-icon"></i>
        <button class="stat-action-btn" onclick="openModal('reservationsModal')">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalRevenue">₱<?php echo number_format($totalRevenue, 2); ?></div>
        <div class="stat-label">Total Revenue</div>
        <i class="fas fa-money-bill-wave fa-2x stat-icon"></i>
        <button class="stat-action-btn" onclick="openModal('revenueModal')">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
      <div class="stat-card">
        <div class="stat-number"><?php echo $totalUsers; ?></div>
        <div class="stat-label">Total Users</div>
        <i class="fas fa-users fa-2x stat-icon"></i>
        <button class="stat-action-btn" onclick="openModal('usersModal')">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="bookRate"><?php echo $bookingRate; ?>%</div>
        <div class="stat-label">Occupancy Rate</div>
        <i class="fas fa-chart-line fa-2x stat-icon"></i>
        <button class="stat-action-btn" onclick="openModal('occupancyModal')">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>

    <!-- Additional Stats Row -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-number"><?php echo $bookedUnits; ?></div>
        <div class="stat-label">Currently Booked Units</div>
        <i class="fas fa-bed fa-2x stat-icon"></i>
      </div>
      <div class="stat-card">
        <div class="stat-number"><?php echo $totalUnits - $bookedUnits; ?></div>
        <div class="stat-label">Available Units</div>
        <i class="fas fa-door-open fa-2x stat-icon"></i>
      </div>
    </div>

    <!-- Reservation Status Breakdown -->
    <div class="stats-breakdown">
      <div class="breakdown-card">
        <h3>Reservation Status</h3>
        <div class="breakdown-grid">
          <div class="breakdown-item pending">
            <span class="breakdown-number"><?php echo $reservationStats['pending'] ?? 0; ?></span>
            <span class="breakdown-label">Pending</span>
          </div>
          <div class="breakdown-item confirmed">
            <span class="breakdown-number"><?php echo $reservationStats['confirmed'] ?? 0; ?></span>
            <span class="breakdown-label">Confirmed</span>
          </div>
          <div class="breakdown-item cancelled">
            <span class="breakdown-number"><?php echo $reservationStats['cancelled'] ?? 0; ?></span>
            <span class="breakdown-label">Cancelled</span>
          </div>
          <div class="breakdown-item completed">
            <span class="breakdown-number"><?php echo $reservationStats['completed'] ?? 0; ?></span>
            <span class="breakdown-label">Completed</span>
          </div>
        </div>
      </div>
      
      <div class="breakdown-card">
        <h3>User Roles</h3>
        <div class="breakdown-grid">
          <div class="breakdown-item admin">
            <span class="breakdown-number"><?php echo $userStats['admin']; ?></span>
            <span class="breakdown-label">Admins</span>
          </div>
          <div class="breakdown-item manager">
            <span class="breakdown-number"><?php echo $userStats['host']; ?></span>
            <span class="breakdown-label">Hosts/Managers</span>
          </div>
          <div class="breakdown-item renter">
            <span class="breakdown-number"><?php echo $userStats['renter']; ?></span>
            <span class="breakdown-label">Renters</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Quick Analysis Charts -->
    <div class="charts-container">
      <!-- Revenue Trend -->
      <div class="chart-card full-width">
        <div class="chart-header">
          <h3 class="chart-title">Monthly Revenue Trend</h3>
        </div>
        <canvas id="revenueChart"></canvas>
      </div>

      <div class="charts-grid">
        <!-- Reservation Status -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Reservations by Status</h3>
          </div>
          <canvas id="reservationsChart"></canvas>
        </div>

        <!-- Units by Type -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Units by Type</h3>
          </div>
          <canvas id="unitsChart"></canvas>
        </div>

        <!-- Users by Role -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Users by Role</h3>
          </div>
          <canvas id="usersChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Recent Activity Feed -->
    <div class="activity-feed">
      <div class="activity-header">
        <h3 class="activity-title">Recent Reservations</h3>
        <a href="/BookIT/admin/reservations.php" class="view-all">View All</a>
      </div>
      <ul class="activity-list">
        <?php if (!empty($recentReservations)): ?>
          <?php foreach ($recentReservations as $reservation): ?>
            <li class="activity-item">
              <div class="activity-info">
                <h4><?php echo htmlspecialchars($reservation['full_name']); ?></h4>
                <p>Unit <?php echo htmlspecialchars($reservation['unit_number']); ?> • <?php echo htmlspecialchars($reservation['branch_name']); ?></p>
                <small><?php echo formatDate($reservation['check_in_date']); ?> to <?php echo formatDate($reservation['check_out_date']); ?></small>
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span class="activity-status status-<?php echo $reservation['status']; ?>">
                  <?php echo ucfirst($reservation['status']); ?>
                </span>
                <button class="btn-icon" onclick="openReservationDetails(<?php echo $reservation['reservation_id']; ?>, '<?php echo htmlspecialchars($reservation['full_name']); ?>', '<?php echo htmlspecialchars($reservation['unit_number']); ?>', '<?php echo $reservation['status']; ?>')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </li>
          <?php endforeach; ?>
        <?php else: ?>
          <li class="activity-item">
            <div class="activity-info">
              <p>No recent reservations</p>
            </div>
          </li>
        <?php endif; ?>
      </ul>
    </div>

    <!-- Revenue History Section -->
    <div class="revenue-history-section">
      <h3 class="section-title"><i class="fas fa-history"></i> Revenue History</h3>
      
      <!-- Tabs for Monthly/Yearly -->
      <ul class="nav nav-tabs revenue-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly-revenue" type="button" role="tab">
            <i class="fas fa-calendar-alt"></i> Monthly (This Year)
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="last-12-tab" data-bs-toggle="tab" data-bs-target="#last-12-revenue" type="button" role="tab">
            <i class="fas fa-chart-line"></i> Last 12 Months
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly-revenue" type="button" role="tab">
            <i class="fas fa-calendar"></i> Yearly Summary
          </button>
        </li>
      </ul>

      <div class="tab-content revenue-content">
        <!-- Monthly Revenue (This Year) -->
        <div class="tab-pane fade show active" id="monthly-revenue" role="tabpanel">
          <div class="table-responsive revenue-table">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Month</th>
                  <th class="text-end">Revenue</th>
                  <th class="text-end">Percentage</th>
                </tr>
              </thead>
              <tbody>
                <?php 
                $total_monthly = 0;
                if (is_array($monthly_revenue) && count($monthly_revenue) > 0) {
                    foreach ($monthly_revenue as $m) {
                        $total_monthly += $m['revenue'];
                    }
                    foreach ($monthly_revenue as $m):
                    $percentage = $total_monthly > 0 ? ($m['revenue'] / $total_monthly) * 100 : 0;
                ?>
                <tr>
                  <td><strong><?php echo $m['month']; ?></strong></td>
                  <td class="text-end"><strong>₱<?php echo number_format($m['revenue'], 0); ?></strong></td>
                  <td class="text-end">
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar bg-success" role="progressbar" style="width: <?php echo $percentage; ?>%">
                        <?php echo number_format($percentage, 1); ?>%
                      </div>
                    </div>
                  </td>
                </tr>
                <?php 
                    endforeach;
                } else {
                    echo '<tr><td colspan="3" class="text-center text-muted py-4">No revenue data for this year</td></tr>';
                }
                ?>
                <?php if ($total_monthly > 0): ?>
                <tr class="total-row">
                  <td><strong>TOTAL</strong></td>
                  <td class="text-end"><strong>₱<?php echo number_format($total_monthly, 0); ?></strong></td>
                  <td class="text-end">100%</td>
                </tr>
                <?php endif; ?>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Last 12 Months Revenue Chart -->
        <div class="tab-pane fade" id="last-12-revenue" role="tabpanel">
          <div class="chart-card" style="margin-top: 20px;">
            <div class="chart-container">
              <canvas id="last12MonthsChartAdmin"></canvas>
            </div>
          </div>
          <div class="table-responsive revenue-table">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Month</th>
                  <th class="text-end">Revenue</th>
                </tr>
              </thead>
              <tbody>
                <?php 
                $total_12_months = 0;
                if (is_array($last_12_months_revenue) && count($last_12_months_revenue) > 0) {
                    foreach ($last_12_months_revenue as $m) {
                        $total_12_months += $m['revenue'];
                    }
                    foreach ($last_12_months_revenue as $m):
                ?>
                <tr>
                  <td><?php echo $m['month_label']; ?></td>
                  <td class="text-end"><strong>₱<?php echo number_format($m['revenue'], 0); ?></strong></td>
                </tr>
                <?php 
                    endforeach;
                } else {
                    echo '<tr><td colspan="2" class="text-center text-muted py-4">No revenue data available</td></tr>';
                }
                ?>
                <tr class="total-row">
                  <td><strong>TOTAL (12 Months)</strong></td>
                  <td class="text-end"><strong>₱<?php echo number_format($total_12_months, 0); ?></strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Yearly Summary -->
        <div class="tab-pane fade" id="yearly-revenue" role="tabpanel">
          <div class="table-responsive revenue-table">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Year</th>
                  <th class="text-end">Total Revenue</th>
                  <th class="text-end">Percentage</th>
                </tr>
              </thead>
              <tbody>
                <?php 
                $total_all_years = 0;
                if (is_array($yearly_revenue) && count($yearly_revenue) > 0) {
                    foreach ($yearly_revenue as $y) {
                        $total_all_years += $y['revenue'];
                    }
                    foreach ($yearly_revenue as $y):
                    $year_percentage = $total_all_years > 0 ? ($y['revenue'] / $total_all_years) * 100 : 0;
                ?>
                <tr>
                  <td><strong><?php echo $y['year']; ?></strong></td>
                  <td class="text-end"><strong>₱<?php echo number_format($y['revenue'], 0); ?></strong></td>
                  <td class="text-end">
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar bg-info" role="progressbar" style="width: <?php echo $year_percentage; ?>%">
                        <?php echo number_format($year_percentage, 1); ?>%
                      </div>
                    </div>
                  </td>
                </tr>
                <?php 
                    endforeach;
                } else {
                    echo '<tr><td colspan="3" class="text-center text-muted py-4">No revenue data available</td></tr>';
                }
                ?>
                <?php if ($total_all_years > 0): ?>
                <tr class="total-row">
                  <td><strong>TOTAL (All Years)</strong></td>
                  <td class="text-end"><strong>₱<?php echo number_format($total_all_years, 0); ?></strong></td>
                  <td class="text-end">100%</td>
                </tr>
                <?php endif; ?>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>
</div>

  <script>
    // Pass PHP data to JavaScript
    const monthlyRevenueData = <?php echo $monthlyRevenueJson; ?>;
    const reservationsStatusData = <?php echo $reservationsStatusJson; ?>;
    const unitsByTypeData = <?php echo $unitsByTypeJson; ?>;
    const usersByRoleData = <?php echo $usersByRoleJson; ?>;

    // Revenue History Data for Charts
    const adminLast12MonthsRevenue = {
        labels: [<?php 
            $labels_12 = [];
            foreach ($last_12_months_revenue as $item) {
                $labels_12[] = "'" . $item['month_label'] . "'";
            }
            echo implode(',', $labels_12);
        ?>],
        data: [<?php 
            $revenues_12 = [];
            foreach ($last_12_months_revenue as $item) {
                $revenues_12[] = $item['revenue'];
            }
            echo implode(',', $revenues_12);
        ?>]
    };
  </script>
  <script src="../assets/js/admin/admin_dashboard.js"></script>
  <script>
    // Last 12 Months Revenue Chart for Admin
    const last12MonthsCtxAdmin = document.getElementById('last12MonthsChartAdmin');
    if (last12MonthsCtxAdmin) {
        new Chart(last12MonthsCtxAdmin.getContext('2d'), {
            type: 'bar',
            data: {
                labels: adminLast12MonthsRevenue.labels,
                datasets: [{
                    label: 'Monthly Revenue (₱)',
                    data: adminLast12MonthsRevenue.data,
                    backgroundColor: '#3498db',
                    borderColor: '#2980b9',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
  </script>

  <!-- =================== MODALS =================== -->
  
  <!-- Branches Modal -->
  <div id="branchesModal" class="modal-overlay" onclick="closeModal('branchesModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-code-branch"></i> Branches Management</h2>
        <button class="modal-close" onclick="closeModal('branchesModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Total Active Branches: <strong><?php echo $totalBranches; ?></strong></p>
        <p>Manage all property branches and their details.</p>
        <div class="modal-actions">
          <a href="/BookIT/admin/manage_branch.php" class="btn btn-primary">
            <i class="fas fa-edit"></i> Manage Branches
          </a>
          <a href="/BookIT/admin/manage_branch.php?action=add" class="btn btn-success">
            <i class="fas fa-plus"></i> Add New Branch
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Units Modal -->
  <div id="unitsModal" class="modal-overlay" onclick="closeModal('unitsModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-home"></i> Units Management</h2>
        <button class="modal-close" onclick="closeModal('unitsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Total Units: <strong><?php echo $totalUnits; ?></strong></p>
        <p>Booked Units: <strong><?php echo $bookedUnits; ?></strong></p>
        <p>Available Units: <strong><?php echo $totalUnits - $bookedUnits; ?></strong></p>
        <div class="modal-actions">
          <a href="/BookIT/admin/unit_management.php" class="btn btn-primary">
            <i class="fas fa-edit"></i> Manage Units
          </a>
          <a href="/BookIT/admin/unit_management.php?action=add" class="btn btn-success">
            <i class="fas fa-plus"></i> Add New Unit
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Reservations Modal -->
  <div id="reservationsModal" class="modal-overlay" onclick="closeModal('reservationsModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-calendar-check"></i> Reservations</h2>
        <button class="modal-close" onclick="closeModal('reservationsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Total Reservations: <strong><?php echo $totalReservations; ?></strong></p>
        <div class="reservation-stats">
          <div class="stat-item"><span>Pending:</span> <strong><?php echo $reservationStats['pending'] ?? 0; ?></strong></div>
          <div class="stat-item"><span>Confirmed:</span> <strong><?php echo $reservationStats['confirmed'] ?? 0; ?></strong></div>
          <div class="stat-item"><span>Cancelled:</span> <strong><?php echo $reservationStats['cancelled'] ?? 0; ?></strong></div>
          <div class="stat-item"><span>Completed:</span> <strong><?php echo $reservationStats['completed'] ?? 0; ?></strong></div>
        </div>
        <div class="modal-actions">
          <a href="/BookIT/modules/reservations.php" class="btn btn-primary">
            <i class="fas fa-list"></i> View All Reservations
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Revenue Modal -->
  <div id="revenueModal" class="modal-overlay" onclick="closeModal('revenueModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-money-bill-wave"></i> Revenue Overview</h2>
        <button class="modal-close" onclick="closeModal('revenueModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Total Revenue: <strong>₱<?php echo number_format($totalRevenue, 2); ?></strong></p>
        <p>Generated from confirmed, checked-in, and completed reservations.</p>
        <div class="modal-actions">
          <a href="/BookIT/modules/payment_management.php" class="btn btn-primary">
            <i class="fas fa-credit-card"></i> Payment Management
          </a>
          <a href="/BookIT/admin/reports.php" class="btn btn-info">
            <i class="fas fa-chart-line"></i> View Reports
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Users Modal -->
  <div id="usersModal" class="modal-overlay" onclick="closeModal('usersModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-users"></i> Users Management</h2>
        <button class="modal-close" onclick="closeModal('usersModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Total Users: <strong><?php echo $totalUsers; ?></strong></p>
        <div class="user-stats">
          <div class="stat-item"><span>Admins:</span> <strong><?php echo $userStats['admin']; ?></strong></div>
          <div class="stat-item"><span>Hosts/Managers:</span> <strong><?php echo $userStats['host']; ?></strong></div>
          <div class="stat-item"><span>Renters:</span> <strong><?php echo $userStats['renter']; ?></strong></div>
        </div>
        <div class="modal-actions">
          <a href="/BookIT/admin/user_management.php" class="btn btn-primary">
            <i class="fas fa-edit"></i> Manage Users
          </a>
          <a href="/BookIT/admin/user_management.php?action=add" class="btn btn-success">
            <i class="fas fa-user-plus"></i> Add New User
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Occupancy Modal -->
  <div id="occupancyModal" class="modal-overlay" onclick="closeModal('occupancyModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-chart-line"></i> Occupancy Rate</h2>
        <button class="modal-close" onclick="closeModal('occupancyModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Current Occupancy Rate: <strong><?php echo $bookingRate; ?>%</strong></p>
        <p>Based on confirmed and checked-in reservations.</p>
        <div class="occupancy-details">
          <div class="detail-row">
            <span>Total Units:</span> <strong><?php echo $totalUnits; ?></strong>
          </div>
          <div class="detail-row">
            <span>Currently Booked:</span> <strong><?php echo $bookedUnits; ?></strong>
          </div>
          <div class="detail-row">
            <span>Available:</span> <strong><?php echo $totalUnits - $bookedUnits; ?></strong>
          </div>
        </div>
        <div class="modal-actions">
          <a href="/BookIT/admin/unit_management.php" class="btn btn-primary">
            <i class="fas fa-home"></i> Unit Management
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Reservation Details Modal -->
  <div id="reservationDetailsModal" class="modal-overlay" onclick="closeModal('reservationDetailsModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-eye"></i> Reservation Details</h2>
        <button class="modal-close" onclick="closeModal('reservationDetailsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="details-grid">
          <div class="detail-item">
            <span class="label">Guest Name:</span>
            <span class="value" id="detailsGuestName">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Unit Number:</span>
            <span class="value" id="detailsUnitNumber">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Reservation ID:</span>
            <span class="value" id="detailsReservationId">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Status:</span>
            <span class="value" id="detailsStatus">-</span>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeModal('reservationDetailsModal')">Close</button>
          <a href="#" id="detailsViewBtn" class="btn btn-primary">
            <i class="fas fa-arrow-right"></i> View Full Details
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Styles and JavaScript -->
  <script>
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }

    function openReservationDetails(id, name, unit, status) {
      document.getElementById('detailsReservationId').textContent = id;
      document.getElementById('detailsGuestName').textContent = name;
      document.getElementById('detailsUnitNumber').textContent = unit;
      document.getElementById('detailsStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);
      document.getElementById('detailsViewBtn').href = '/BookIT/modules/reservations.php?id=' + id;
      openModal('reservationDetailsModal');
    }

    // Close modal when pressing ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
          if (modal.style.display === 'flex') {
            closeModal(modal.id);
          }
        });
      }
    });
  </script>

</body>
</html>

C:\wamp64\www\BookIT\admin\admin_profile.php

<?php
// Admin Profile Management
// Allow admins to view and edit their own profile

include_once '../config/db.php';
include_once '../includes/session.php';
include_once '../includes/functions.php';
checkRole(['admin']);

$admin_id = $_SESSION['user_id'];
$message = '';
$error = '';

// Fetch admin data
$admin = [];
$query = "SELECT * FROM users WHERE user_id = ? AND role = 'admin'";
$stmt = $conn->prepare($query);
$stmt->bind_param("i", $admin_id);
$stmt->execute();
$result = $stmt->get_result();
$admin = $result->fetch_assoc();
$stmt->close();

if (!$admin) {
    $error = "Admin profile not found";
}

// Handle profile update
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['update_profile'])) {
    $full_name = sanitize_input($_POST['full_name']);
    $email = sanitize_input($_POST['email']);
    $phone = sanitize_input($_POST['phone'] ?? '');
    
    // Validate email uniqueness (excluding current admin)
    $email_check = "SELECT user_id FROM users WHERE email = ? AND user_id != ?";
    $stmt = $conn->prepare($email_check);
    $stmt->bind_param("si", $email, $admin_id);
    $stmt->execute();
    $email_result = $stmt->get_result();
    $stmt->close();
    
    if ($email_result->num_rows > 0) {
        $error = "Email address already in use";
    } else {
        $update_query = "UPDATE users SET full_name = ?, email = ?, phone = ? WHERE user_id = ?";
        $stmt = $conn->prepare($update_query);
        $stmt->bind_param("sssi", $full_name, $email, $phone, $admin_id);
        
        if ($stmt->execute()) {
            $message = "Profile updated successfully!";
            // Refresh admin data
            $admin['full_name'] = $full_name;
            $admin['email'] = $email;
            $admin['phone'] = $phone;
        } else {
            $error = "Failed to update profile: " . $stmt->error;
        }
        $stmt->close();
    }
}

// Handle password change
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['change_password'])) {
    $current_password = $_POST['current_password'];
    $new_password = $_POST['new_password'];
    $confirm_password = $_POST['confirm_password'];
    
    // Verify current password
    if (!password_verify($current_password, $admin['password_hash'])) {
        $error = "Current password is incorrect";
    } elseif (strlen($new_password) < 8) {
        $error = "New password must be at least 8 characters";
    } elseif ($new_password !== $confirm_password) {
        $error = "Passwords do not match";
    } else {
        $hashed_password = password_hash($new_password, PASSWORD_DEFAULT);
        $pwd_query = "UPDATE users SET password_hash = ? WHERE user_id = ?";
        $stmt = $conn->prepare($pwd_query);
        $stmt->bind_param("si", $hashed_password, $admin_id);
        
        if ($stmt->execute()) {
            $message = "Password changed successfully!";
        } else {
            $error = "Failed to change password: " . $stmt->error;
        }
        $stmt->close();
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Profile</title>
    <link rel="stylesheet" href="../assets/css/admin/admin_dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .profile-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        
        .profile-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            flex-shrink: 0;
        }
        
        .profile-info h2 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }
        
        .profile-info p {
            margin: 5px 0;
            color: #666;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1.5px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #2c3e50;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <?php include '../includes/sidebar.php'; ?>
        
        <main class="content">
            <div class="profile-container">
                <!-- Header -->
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="profile-info">
                        <h2><?php echo htmlspecialchars($admin['full_name'] ?? 'Admin'); ?></h2>
                        <p><?php echo htmlspecialchars($admin['email'] ?? 'admin@system.com'); ?></p>
                        <p><small>Role: <strong>Administrator</strong></small></p>
                    </div>
                </div>
                
                <!-- Messages -->
                <?php if ($message): ?>
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> <?php echo $message; ?>
                    </div>
                <?php endif; ?>
                
                <?php if ($error): ?>
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-circle"></i> <?php echo $error; ?>
                    </div>
                <?php endif; ?>
                
                <!-- Profile Card -->
                <div class="profile-card">
                    <form method="POST" action="">
                        <div class="form-section">
                            <h3><i class="fas fa-user"></i> Personal Information</h3>
                            
                            <div class="form-group">
                                <label for="full_name">Full Name</label>
                                <input type="text" id="full_name" name="full_name" 
                                    value="<?php echo htmlspecialchars($admin['full_name'] ?? ''); ?>" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" name="email" 
                                    value="<?php echo htmlspecialchars($admin['email'] ?? ''); ?>" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" name="phone" 
                                    value="<?php echo htmlspecialchars($admin['phone'] ?? ''); ?>" 
                                    placeholder="Optional">
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" name="update_profile" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Password Card -->
                <div class="profile-card">
                    <form method="POST" action="">
                        <div class="form-section">
                            <h3><i class="fas fa-lock"></i> Change Password</h3>
                            
                            <div class="form-group">
                                <label for="current_password">Current Password</label>
                                <input type="password" id="current_password" name="current_password" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="new_password">New Password</label>
                                <input type="password" id="new_password" name="new_password" 
                                    placeholder="Minimum 8 characters" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirm_password">Confirm Password</label>
                                <input type="password" id="confirm_password" name="confirm_password" required>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" name="change_password" class="btn btn-primary">
                                    <i class="fas fa-key"></i> Change Password
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Account Info Card -->
                <div class="profile-card">
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> Account Information</h3>
                        
                        <div class="form-group">
                            <label>User ID:</label>
                            <input type="text" value="<?php echo htmlspecialchars($admin['user_id'] ?? ''); ?>" disabled>
                        </div>
                        
                        <div class="form-group">
                            <label>Account Created:</label>
                            <input type="text" value="<?php echo isset($admin['created_at']) ? date('F d, Y H:i', strtotime($admin['created_at'])) : 'N/A'; ?>" disabled>
                        </div>
                        
                        <div class="form-group">
                            <label>Account Status:</label>
                            <input type="text" value="<?php echo ($admin['is_active'] ?? 1) ? 'Active' : 'Inactive'; ?>" disabled>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
</body>
</html>

C:\wamp64\www\BookIT\admin\get_edit_unit_form.php
C:\wamp64\www\BookIT\admin\admin_dashboard.php
<?php
// superadmin/index.php - MAIN DASHBOARD
// Pull summary data for charts from the database
include_once '../config/db.php';
include '../includes/session.php';
include '../includes/functions.php';
checkRole(['admin']);

// Additional statistics using your existing functions - UPDATED
$totalUsers = 0;
$totalBranches = 0;
$totalUnits = 0;
$totalReservations = 0;
$totalRevenue = 0;

// Total Users (Host & Renters) - Only active
$result = $conn->query("SELECT COUNT(*) as cnt FROM users WHERE is_active = 1");
if ($result && $row = $result->fetch_assoc()) $totalUsers = (int)$row['cnt'];

// Total Branches - Only active
$result = $conn->query("SELECT COUNT(*) as cnt FROM branches WHERE is_active = 1");
if ($result && $row = $result->fetch_assoc()) $totalBranches = (int)$row['cnt'];

// Total Units (Listings) - Only from active branches
$result = $conn->query("SELECT COUNT(*) as cnt FROM units u 
                       JOIN branches b ON u.branch_id = b.branch_id 
                       WHERE b.is_active = 1");
if ($result && $row = $result->fetch_assoc()) $totalUnits = (int)$row['cnt'];

// Total Reservations - Only from active branches
$result = $conn->query("SELECT COUNT(*) as cnt FROM reservations r 
                       JOIN branches b ON r.branch_id = b.branch_id 
                       WHERE b.is_active = 1");
if ($result && $row = $result->fetch_assoc()) $totalReservations = (int)$row['cnt'];

// Total Revenue (from reservations) - Only from active branches
$result = $conn->query("SELECT SUM(r.total_amount) as total FROM reservations r 
                       JOIN branches b ON r.branch_id = b.branch_id 
                       WHERE r.status IN ('confirmed', 'checked_in', 'completed') 
                       AND b.is_active = 1");
if ($result && $row = $result->fetch_assoc()) $totalRevenue = (float)$row['total'];

// CORRECTED: Booking Rate Calculation - Number of unique booked units from ACTIVE branches
$result = $conn->query("SELECT COUNT(DISTINCT r.unit_id) as booked_units 
                       FROM reservations r 
                       JOIN branches b ON r.branch_id = b.branch_id 
                       WHERE r.status IN ('confirmed', 'checked_in') 
                       AND b.is_active = 1");
$bookedUnits = 0;
if ($result && $row = $result->fetch_assoc()) $bookedUnits = (int)$row['booked_units'];

// Calculate booking rate (max 100%) - Only from active branches
$bookingRate = $totalUnits > 0 ? min(round(($bookedUnits / $totalUnits) * 100, 1), 100) : 0;

// Reservation Status Breakdown
$reservationStats = [
    'pending' => 0,
    'confirmed' => 0,
    'checked_in' => 0,
    'cancelled' => 0,
    'completed' => 0
];

$result = $conn->query("SELECT status, COUNT(*) as cnt FROM reservations GROUP BY status");
if ($result) {
    while ($row = $result->fetch_assoc()) {
        $status = $row['status'] ?? 'unknown';
        if (isset($reservationStats[$status])) {
            $reservationStats[$status] = (int)$row['cnt'];
        }
    }
}

// User Role Breakdown
$userStats = [
    'admin' => 0,
    'host' => 0,
    'renter' => 0,
    'manager' => 0  // For compatibility
];

$result = $conn->query("SELECT role, COUNT(*) as cnt FROM users GROUP BY role");
if ($result) {
    while ($row = $result->fetch_assoc()) {
        $userStats[$row['role']] = (int)$row['cnt'];
    }
}

// Get recent reservations for the activity feed
$recentReservations = get_multiple_results(
    "SELECT r.*, u.full_name, un.unit_number, b.branch_name 
     FROM reservations r 
     JOIN users u ON r.user_id = u.user_id 
     JOIN units un ON r.unit_id = un.unit_id 
     JOIN branches b ON r.branch_id = b.branch_id 
     ORDER BY r.created_at DESC LIMIT 5"
);

// Monthly Revenue Data for Chart
$monthlyRevenue = fetch_pairs($conn, 
    "SELECT DATE_FORMAT(created_at, '%Y-%m') as month, 
            SUM(total_amount) as revenue 
     FROM reservations 
     WHERE status IN ('confirmed', 'checked_in', 'completed')
     GROUP BY DATE_FORMAT(created_at, '%Y-%m')
     ORDER BY month DESC LIMIT 6", 
    'month', 'revenue'
);

// Monthly Revenue Data for current year
$monthly_revenue = get_multiple_results("
    SELECT 
        DATE_FORMAT(created_at, '%b') as month,
        MONTH(created_at) as month_num,
        COALESCE(SUM(total_amount), 0) as revenue
    FROM reservations
    WHERE YEAR(created_at) = YEAR(CURDATE())
    AND status IN ('confirmed', 'checked_in', 'completed')
    AND payment_status = 'completed'
    GROUP BY MONTH(created_at), DATE_FORMAT(created_at, '%b')
    ORDER BY MONTH(created_at)
");

// Yearly Revenue Data for history
$yearly_revenue = get_multiple_results("
    SELECT 
        YEAR(created_at) as year,
        COALESCE(SUM(total_amount), 0) as revenue
    FROM reservations
    WHERE status IN ('confirmed', 'checked_in', 'completed')
    AND payment_status = 'completed'
    GROUP BY YEAR(created_at)
    ORDER BY YEAR(created_at) DESC
");

// Last 12 months revenue data for detailed chart
$last_12_months_revenue = get_multiple_results("
    SELECT 
        DATE_FORMAT(created_at, '%Y-%m') as month_year,
        DATE_FORMAT(created_at, '%b %y') as month_label,
        COALESCE(SUM(total_amount), 0) as revenue
    FROM reservations
    WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)
    AND status IN ('confirmed', 'checked_in', 'completed')
    AND payment_status = 'completed'
    GROUP BY DATE_FORMAT(created_at, '%Y-%m'), DATE_FORMAT(created_at, '%b %y')
    ORDER BY DATE_FORMAT(created_at, '%Y-%m')
");

// Reservation Status for Pie Chart
$reservationsStatus = fetch_pairs($conn, 
    "SELECT COALESCE(status,'Unknown') AS status, COUNT(*) AS cnt 
     FROM reservations 
     GROUP BY status", 
    'status', 'cnt'
);

// Units by Type for Chart
$unitsByType = fetch_pairs($conn, 
    "SELECT COALESCE(unit_type,'Unknown') AS type, COUNT(*) AS cnt 
     FROM units 
     GROUP BY unit_type 
     ORDER BY cnt DESC", 
    'type', 'cnt'
);

// Users by Role for Chart
$usersByRole = fetch_pairs($conn, 
    "SELECT COALESCE(role,'Unknown') AS role, COUNT(*) AS cnt 
     FROM users 
     GROUP BY role 
     ORDER BY cnt DESC", 
    'role', 'cnt'
);

// JSON encode for front-end
$monthlyRevenueJson = json_encode($monthlyRevenue);
$reservationsStatusJson = json_encode($reservationsStatus);
$unitsByTypeJson = json_encode($unitsByType);
$usersByRoleJson = json_encode($usersByRole);
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="../assets/css/admin/admin_dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container-fluid">
        <div class="row">
  <?php include '../includes/sidebar.php'; ?>

  <!-- =================== DASHBOARD CONTENT =================== -->
  <main class="content">
    <div class="dashboard-header">
      <h1>Admin Dashboard Overview</h1>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-number"><?php echo $totalBranches; ?></div>
        <div class="stat-label">Total Branches</div>
        <i class="fas fa-code-branch fa-2x stat-icon"></i>
        <button class="stat-action-btn" onclick="openModal('branchesModal')">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
      <div class="stat-card">
        <div class="stat-number"><?php echo $totalUnits; ?></div>
        <div class="stat-label">Total Units</div>
        <i class="fas fa-home fa-2x stat-icon"></i>
        <button class="stat-action-btn" onclick="openModal('unitsModal')">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
      <div class="stat-card">
        <div class="stat-number"><?php echo $totalReservations; ?></div>
        <div class="stat-label">Total Reservations</div>
        <i class="fas fa-calendar-check fa-2x stat-icon"></i>
        <button class="stat-action-btn" onclick="openModal('reservationsModal')">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalRevenue">₱<?php echo number_format($totalRevenue, 2); ?></div>
        <div class="stat-label">Total Revenue</div>
        <i class="fas fa-money-bill-wave fa-2x stat-icon"></i>
        <button class="stat-action-btn" onclick="openModal('revenueModal')">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
      <div class="stat-card">
        <div class="stat-number"><?php echo $totalUsers; ?></div>
        <div class="stat-label">Total Users</div>
        <i class="fas fa-users fa-2x stat-icon"></i>
        <button class="stat-action-btn" onclick="openModal('usersModal')">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="bookRate"><?php echo $bookingRate; ?>%</div>
        <div class="stat-label">Occupancy Rate</div>
        <i class="fas fa-chart-line fa-2x stat-icon"></i>
        <button class="stat-action-btn" onclick="openModal('occupancyModal')">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>

    <!-- Additional Stats Row -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-number"><?php echo $bookedUnits; ?></div>
        <div class="stat-label">Currently Booked Units</div>
        <i class="fas fa-bed fa-2x stat-icon"></i>
      </div>
      <div class="stat-card">
        <div class="stat-number"><?php echo $totalUnits - $bookedUnits; ?></div>
        <div class="stat-label">Available Units</div>
        <i class="fas fa-door-open fa-2x stat-icon"></i>
      </div>
    </div>

    <!-- Reservation Status Breakdown -->
    <div class="stats-breakdown">
      <div class="breakdown-card">
        <h3>Reservation Status</h3>
        <div class="breakdown-grid">
          <div class="breakdown-item pending">
            <span class="breakdown-number"><?php echo $reservationStats['pending'] ?? 0; ?></span>
            <span class="breakdown-label">Pending</span>
          </div>
          <div class="breakdown-item confirmed">
            <span class="breakdown-number"><?php echo $reservationStats['confirmed'] ?? 0; ?></span>
            <span class="breakdown-label">Confirmed</span>
          </div>
          <div class="breakdown-item cancelled">
            <span class="breakdown-number"><?php echo $reservationStats['cancelled'] ?? 0; ?></span>
            <span class="breakdown-label">Cancelled</span>
          </div>
          <div class="breakdown-item completed">
            <span class="breakdown-number"><?php echo $reservationStats['completed'] ?? 0; ?></span>
            <span class="breakdown-label">Completed</span>
          </div>
        </div>
      </div>
      
      <div class="breakdown-card">
        <h3>User Roles</h3>
        <div class="breakdown-grid">
          <div class="breakdown-item admin">
            <span class="breakdown-number"><?php echo $userStats['admin']; ?></span>
            <span class="breakdown-label">Admins</span>
          </div>
          <div class="breakdown-item manager">
            <span class="breakdown-number"><?php echo $userStats['host']; ?></span>
            <span class="breakdown-label">Hosts/Managers</span>
          </div>
          <div class="breakdown-item renter">
            <span class="breakdown-number"><?php echo $userStats['renter']; ?></span>
            <span class="breakdown-label">Renters</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Quick Analysis Charts -->
    <div class="charts-container">
      <!-- Revenue Trend -->
      <div class="chart-card full-width">
        <div class="chart-header">
          <h3 class="chart-title">Monthly Revenue Trend</h3>
        </div>
        <canvas id="revenueChart"></canvas>
      </div>

      <div class="charts-grid">
        <!-- Reservation Status -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Reservations by Status</h3>
          </div>
          <canvas id="reservationsChart"></canvas>
        </div>

        <!-- Units by Type -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Units by Type</h3>
          </div>
          <canvas id="unitsChart"></canvas>
        </div>

        <!-- Users by Role -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Users by Role</h3>
          </div>
          <canvas id="usersChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Recent Activity Feed -->
    <div class="activity-feed">
      <div class="activity-header">
        <h3 class="activity-title">Recent Reservations</h3>
        <a href="/BookIT/admin/reservations.php" class="view-all">View All</a>
      </div>
      <ul class="activity-list">
        <?php if (!empty($recentReservations)): ?>
          <?php foreach ($recentReservations as $reservation): ?>
            <li class="activity-item">
              <div class="activity-info">
                <h4><?php echo htmlspecialchars($reservation['full_name']); ?></h4>
                <p>Unit <?php echo htmlspecialchars($reservation['unit_number']); ?> • <?php echo htmlspecialchars($reservation['branch_name']); ?></p>
                <small><?php echo formatDate($reservation['check_in_date']); ?> to <?php echo formatDate($reservation['check_out_date']); ?></small>
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span class="activity-status status-<?php echo $reservation['status']; ?>">
                  <?php echo ucfirst($reservation['status']); ?>
                </span>
                <button class="btn-icon" onclick="openReservationDetails(<?php echo $reservation['reservation_id']; ?>, '<?php echo htmlspecialchars($reservation['full_name']); ?>', '<?php echo htmlspecialchars($reservation['unit_number']); ?>', '<?php echo $reservation['status']; ?>')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </li>
          <?php endforeach; ?>
        <?php else: ?>
          <li class="activity-item">
            <div class="activity-info">
              <p>No recent reservations</p>
            </div>
          </li>
        <?php endif; ?>
      </ul>
    </div>

    <!-- Revenue History Section -->
    <div class="revenue-history-section">
      <h3 class="section-title"><i class="fas fa-history"></i> Revenue History</h3>
      
      <!-- Tabs for Monthly/Yearly -->
      <ul class="nav nav-tabs revenue-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly-revenue" type="button" role="tab">
            <i class="fas fa-calendar-alt"></i> Monthly (This Year)
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="last-12-tab" data-bs-toggle="tab" data-bs-target="#last-12-revenue" type="button" role="tab">
            <i class="fas fa-chart-line"></i> Last 12 Months
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly-revenue" type="button" role="tab">
            <i class="fas fa-calendar"></i> Yearly Summary
          </button>
        </li>
      </ul>

      <div class="tab-content revenue-content">
        <!-- Monthly Revenue (This Year) -->
        <div class="tab-pane fade show active" id="monthly-revenue" role="tabpanel">
          <div class="table-responsive revenue-table">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Month</th>
                  <th class="text-end">Revenue</th>
                  <th class="text-end">Percentage</th>
                </tr>
              </thead>
              <tbody>
                <?php 
                $total_monthly = 0;
                if (is_array($monthly_revenue) && count($monthly_revenue) > 0) {
                    foreach ($monthly_revenue as $m) {
                        $total_monthly += $m['revenue'];
                    }
                    foreach ($monthly_revenue as $m):
                    $percentage = $total_monthly > 0 ? ($m['revenue'] / $total_monthly) * 100 : 0;
                ?>
                <tr>
                  <td><strong><?php echo $m['month']; ?></strong></td>
                  <td class="text-end"><strong>₱<?php echo number_format($m['revenue'], 0); ?></strong></td>
                  <td class="text-end">
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar bg-success" role="progressbar" style="width: <?php echo $percentage; ?>%">
                        <?php echo number_format($percentage, 1); ?>%
                      </div>
                    </div>
                  </td>
                </tr>
                <?php 
                    endforeach;
                } else {
                    echo '<tr><td colspan="3" class="text-center text-muted py-4">No revenue data for this year</td></tr>';
                }
                ?>
                <?php if ($total_monthly > 0): ?>
                <tr class="total-row">
                  <td><strong>TOTAL</strong></td>
                  <td class="text-end"><strong>₱<?php echo number_format($total_monthly, 0); ?></strong></td>
                  <td class="text-end">100%</td>
                </tr>
                <?php endif; ?>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Last 12 Months Revenue Chart -->
        <div class="tab-pane fade" id="last-12-revenue" role="tabpanel">
          <div class="chart-card" style="margin-top: 20px;">
            <div class="chart-container">
              <canvas id="last12MonthsChartAdmin"></canvas>
            </div>
          </div>
          <div class="table-responsive revenue-table">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Month</th>
                  <th class="text-end">Revenue</th>
                </tr>
              </thead>
              <tbody>
                <?php 
                $total_12_months = 0;
                if (is_array($last_12_months_revenue) && count($last_12_months_revenue) > 0) {
                    foreach ($last_12_months_revenue as $m) {
                        $total_12_months += $m['revenue'];
                    }
                    foreach ($last_12_months_revenue as $m):
                ?>
                <tr>
                  <td><?php echo $m['month_label']; ?></td>
                  <td class="text-end"><strong>₱<?php echo number_format($m['revenue'], 0); ?></strong></td>
                </tr>
                <?php 
                    endforeach;
                } else {
                    echo '<tr><td colspan="2" class="text-center text-muted py-4">No revenue data available</td></tr>';
                }
                ?>
                <tr class="total-row">
                  <td><strong>TOTAL (12 Months)</strong></td>
                  <td class="text-end"><strong>₱<?php echo number_format($total_12_months, 0); ?></strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Yearly Summary -->
        <div class="tab-pane fade" id="yearly-revenue" role="tabpanel">
          <div class="table-responsive revenue-table">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Year</th>
                  <th class="text-end">Total Revenue</th>
                  <th class="text-end">Percentage</th>
                </tr>
              </thead>
              <tbody>
                <?php 
                $total_all_years = 0;
                if (is_array($yearly_revenue) && count($yearly_revenue) > 0) {
                    foreach ($yearly_revenue as $y) {
                        $total_all_years += $y['revenue'];
                    }
                    foreach ($yearly_revenue as $y):
                    $year_percentage = $total_all_years > 0 ? ($y['revenue'] / $total_all_years) * 100 : 0;
                ?>
                <tr>
                  <td><strong><?php echo $y['year']; ?></strong></td>
                  <td class="text-end"><strong>₱<?php echo number_format($y['revenue'], 0); ?></strong></td>
                  <td class="text-end">
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar bg-info" role="progressbar" style="width: <?php echo $year_percentage; ?>%">
                        <?php echo number_format($year_percentage, 1); ?>%
                      </div>
                    </div>
                  </td>
                </tr>
                <?php 
                    endforeach;
                } else {
                    echo '<tr><td colspan="3" class="text-center text-muted py-4">No revenue data available</td></tr>';
                }
                ?>
                <?php if ($total_all_years > 0): ?>
                <tr class="total-row">
                  <td><strong>TOTAL (All Years)</strong></td>
                  <td class="text-end"><strong>₱<?php echo number_format($total_all_years, 0); ?></strong></td>
                  <td class="text-end">100%</td>
                </tr>
                <?php endif; ?>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>
</div>

  <script>
    // Pass PHP data to JavaScript
    const monthlyRevenueData = <?php echo $monthlyRevenueJson; ?>;
    const reservationsStatusData = <?php echo $reservationsStatusJson; ?>;
    const unitsByTypeData = <?php echo $unitsByTypeJson; ?>;
    const usersByRoleData = <?php echo $usersByRoleJson; ?>;

    // Revenue History Data for Charts
    const adminLast12MonthsRevenue = {
        labels: [<?php 
            $labels_12 = [];
            foreach ($last_12_months_revenue as $item) {
                $labels_12[] = "'" . $item['month_label'] . "'";
            }
            echo implode(',', $labels_12);
        ?>],
        data: [<?php 
            $revenues_12 = [];
            foreach ($last_12_months_revenue as $item) {
                $revenues_12[] = $item['revenue'];
            }
            echo implode(',', $revenues_12);
        ?>]
    };
  </script>
  <script src="../assets/js/admin/admin_dashboard.js"></script>
  <script>
    // Last 12 Months Revenue Chart for Admin
    const last12MonthsCtxAdmin = document.getElementById('last12MonthsChartAdmin');
    if (last12MonthsCtxAdmin) {
        new Chart(last12MonthsCtxAdmin.getContext('2d'), {
            type: 'bar',
            data: {
                labels: adminLast12MonthsRevenue.labels,
                datasets: [{
                    label: 'Monthly Revenue (₱)',
                    data: adminLast12MonthsRevenue.data,
                    backgroundColor: '#3498db',
                    borderColor: '#2980b9',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
  </script>

  <!-- =================== MODALS =================== -->
  
  <!-- Branches Modal -->
  <div id="branchesModal" class="modal-overlay" onclick="closeModal('branchesModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-code-branch"></i> Branches Management</h2>
        <button class="modal-close" onclick="closeModal('branchesModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Total Active Branches: <strong><?php echo $totalBranches; ?></strong></p>
        <p>Manage all property branches and their details.</p>
        <div class="modal-actions">
          <a href="/BookIT/admin/manage_branch.php" class="btn btn-primary">
            <i class="fas fa-edit"></i> Manage Branches
          </a>
          <a href="/BookIT/admin/manage_branch.php?action=add" class="btn btn-success">
            <i class="fas fa-plus"></i> Add New Branch
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Units Modal -->
  <div id="unitsModal" class="modal-overlay" onclick="closeModal('unitsModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-home"></i> Units Management</h2>
        <button class="modal-close" onclick="closeModal('unitsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Total Units: <strong><?php echo $totalUnits; ?></strong></p>
        <p>Booked Units: <strong><?php echo $bookedUnits; ?></strong></p>
        <p>Available Units: <strong><?php echo $totalUnits - $bookedUnits; ?></strong></p>
        <div class="modal-actions">
          <a href="/BookIT/admin/unit_management.php" class="btn btn-primary">
            <i class="fas fa-edit"></i> Manage Units
          </a>
          <a href="/BookIT/admin/unit_management.php?action=add" class="btn btn-success">
            <i class="fas fa-plus"></i> Add New Unit
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Reservations Modal -->
  <div id="reservationsModal" class="modal-overlay" onclick="closeModal('reservationsModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-calendar-check"></i> Reservations</h2>
        <button class="modal-close" onclick="closeModal('reservationsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Total Reservations: <strong><?php echo $totalReservations; ?></strong></p>
        <div class="reservation-stats">
          <div class="stat-item"><span>Pending:</span> <strong><?php echo $reservationStats['pending'] ?? 0; ?></strong></div>
          <div class="stat-item"><span>Confirmed:</span> <strong><?php echo $reservationStats['confirmed'] ?? 0; ?></strong></div>
          <div class="stat-item"><span>Cancelled:</span> <strong><?php echo $reservationStats['cancelled'] ?? 0; ?></strong></div>
          <div class="stat-item"><span>Completed:</span> <strong><?php echo $reservationStats['completed'] ?? 0; ?></strong></div>
        </div>
        <div class="modal-actions">
          <a href="/BookIT/modules/reservations.php" class="btn btn-primary">
            <i class="fas fa-list"></i> View All Reservations
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Revenue Modal -->
  <div id="revenueModal" class="modal-overlay" onclick="closeModal('revenueModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-money-bill-wave"></i> Revenue Overview</h2>
        <button class="modal-close" onclick="closeModal('revenueModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Total Revenue: <strong>₱<?php echo number_format($totalRevenue, 2); ?></strong></p>
        <p>Generated from confirmed, checked-in, and completed reservations.</p>
        <div class="modal-actions">
          <a href="/BookIT/modules/payment_management.php" class="btn btn-primary">
            <i class="fas fa-credit-card"></i> Payment Management
          </a>
          <a href="/BookIT/admin/reports.php" class="btn btn-info">
            <i class="fas fa-chart-line"></i> View Reports
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Users Modal -->
  <div id="usersModal" class="modal-overlay" onclick="closeModal('usersModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-users"></i> Users Management</h2>
        <button class="modal-close" onclick="closeModal('usersModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Total Users: <strong><?php echo $totalUsers; ?></strong></p>
        <div class="user-stats">
          <div class="stat-item"><span>Admins:</span> <strong><?php echo $userStats['admin']; ?></strong></div>
          <div class="stat-item"><span>Hosts/Managers:</span> <strong><?php echo $userStats['host']; ?></strong></div>
          <div class="stat-item"><span>Renters:</span> <strong><?php echo $userStats['renter']; ?></strong></div>
        </div>
        <div class="modal-actions">
          <a href="/BookIT/admin/user_management.php" class="btn btn-primary">
            <i class="fas fa-edit"></i> Manage Users
          </a>
          <a href="/BookIT/admin/user_management.php?action=add" class="btn btn-success">
            <i class="fas fa-user-plus"></i> Add New User
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Occupancy Modal -->
  <div id="occupancyModal" class="modal-overlay" onclick="closeModal('occupancyModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-chart-line"></i> Occupancy Rate</h2>
        <button class="modal-close" onclick="closeModal('occupancyModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Current Occupancy Rate: <strong><?php echo $bookingRate; ?>%</strong></p>
        <p>Based on confirmed and checked-in reservations.</p>
        <div class="occupancy-details">
          <div class="detail-row">
            <span>Total Units:</span> <strong><?php echo $totalUnits; ?></strong>
          </div>
          <div class="detail-row">
            <span>Currently Booked:</span> <strong><?php echo $bookedUnits; ?></strong>
          </div>
          <div class="detail-row">
            <span>Available:</span> <strong><?php echo $totalUnits - $bookedUnits; ?></strong>
          </div>
        </div>
        <div class="modal-actions">
          <a href="/BookIT/admin/unit_management.php" class="btn btn-primary">
            <i class="fas fa-home"></i> Unit Management
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Reservation Details Modal -->
  <div id="reservationDetailsModal" class="modal-overlay" onclick="closeModal('reservationDetailsModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-eye"></i> Reservation Details</h2>
        <button class="modal-close" onclick="closeModal('reservationDetailsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="details-grid">
          <div class="detail-item">
            <span class="label">Guest Name:</span>
            <span class="value" id="detailsGuestName">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Unit Number:</span>
            <span class="value" id="detailsUnitNumber">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Reservation ID:</span>
            <span class="value" id="detailsReservationId">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Status:</span>
            <span class="value" id="detailsStatus">-</span>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeModal('reservationDetailsModal')">Close</button>
          <a href="#" id="detailsViewBtn" class="btn btn-primary">
            <i class="fas fa-arrow-right"></i> View Full Details
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Styles and JavaScript -->
  <script>
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }

    function openReservationDetails(id, name, unit, status) {
      document.getElementById('detailsReservationId').textContent = id;
      document.getElementById('detailsGuestName').textContent = name;
      document.getElementById('detailsUnitNumber').textContent = unit;
      document.getElementById('detailsStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);
      document.getElementById('detailsViewBtn').href = '/BookIT/modules/reservations.php?id=' + id;
      openModal('reservationDetailsModal');
    }

    // Close modal when pressing ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
          if (modal.style.display === 'flex') {
            closeModal(modal.id);
          }
        });
      }
    });
  </script>

</body>
</html>

C:\wamp64\www\BookIT\admin\admin_profile.php

<?php
// Admin Profile Management
// Allow admins to view and edit their own profile

include_once '../config/db.php';
include_once '../includes/session.php';
include_once '../includes/functions.php';
checkRole(['admin']);

$admin_id = $_SESSION['user_id'];
$message = '';
$error = '';

// Fetch admin data
$admin = [];
$query = "SELECT * FROM users WHERE user_id = ? AND role = 'admin'";
$stmt = $conn->prepare($query);
$stmt->bind_param("i", $admin_id);
$stmt->execute();
$result = $stmt->get_result();
$admin = $result->fetch_assoc();
$stmt->close();

if (!$admin) {
    $error = "Admin profile not found";
}

// Handle profile update
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['update_profile'])) {
    $full_name = sanitize_input($_POST['full_name']);
    $email = sanitize_input($_POST['email']);
    $phone = sanitize_input($_POST['phone'] ?? '');
    
    // Validate email uniqueness (excluding current admin)
    $email_check = "SELECT user_id FROM users WHERE email = ? AND user_id != ?";
    $stmt = $conn->prepare($email_check);
    $stmt->bind_param("si", $email, $admin_id);
    $stmt->execute();
    $email_result = $stmt->get_result();
    $stmt->close();
    
    if ($email_result->num_rows > 0) {
        $error = "Email address already in use";
    } else {
        $update_query = "UPDATE users SET full_name = ?, email = ?, phone = ? WHERE user_id = ?";
        $stmt = $conn->prepare($update_query);
        $stmt->bind_param("sssi", $full_name, $email, $phone, $admin_id);
        
        if ($stmt->execute()) {
            $message = "Profile updated successfully!";
            // Refresh admin data
            $admin['full_name'] = $full_name;
            $admin['email'] = $email;
            $admin['phone'] = $phone;
        } else {
            $error = "Failed to update profile: " . $stmt->error;
        }
        $stmt->close();
    }
}

// Handle password change
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['change_password'])) {
    $current_password = $_POST['current_password'];
    $new_password = $_POST['new_password'];
    $confirm_password = $_POST['confirm_password'];
    
    // Verify current password
    if (!password_verify($current_password, $admin['password_hash'])) {
        $error = "Current password is incorrect";
    } elseif (strlen($new_password) < 8) {
        $error = "New password must be at least 8 characters";
    } elseif ($new_password !== $confirm_password) {
        $error = "Passwords do not match";
    } else {
        $hashed_password = password_hash($new_password, PASSWORD_DEFAULT);
        $pwd_query = "UPDATE users SET password_hash = ? WHERE user_id = ?";
        $stmt = $conn->prepare($pwd_query);
        $stmt->bind_param("si", $hashed_password, $admin_id);
        
        if ($stmt->execute()) {
            $message = "Password changed successfully!";
        } else {
            $error = "Failed to change password: " . $stmt->error;
        }
        $stmt->close();
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Profile</title>
    <link rel="stylesheet" href="../assets/css/admin/admin_dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .profile-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        
        .profile-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            flex-shrink: 0;
        }
        
        .profile-info h2 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }
        
        .profile-info p {
            margin: 5px 0;
            color: #666;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1.5px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #2c3e50;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <?php include '../includes/sidebar.php'; ?>
        
        <main class="content">
            <div class="profile-container">
                <!-- Header -->
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="profile-info">
                        <h2><?php echo htmlspecialchars($admin['full_name'] ?? 'Admin'); ?></h2>
                        <p><?php echo htmlspecialchars($admin['email'] ?? 'admin@system.com'); ?></p>
                        <p><small>Role: <strong>Administrator</strong></small></p>
                    </div>
                </div>
                
                <!-- Messages -->
                <?php if ($message): ?>
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> <?php echo $message; ?>
                    </div>
                <?php endif; ?>
                
                <?php if ($error): ?>
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-circle"></i> <?php echo $error; ?>
                    </div>
                <?php endif; ?>
                
                <!-- Profile Card -->
                <div class="profile-card">
                    <form method="POST" action="">
                        <div class="form-section">
                            <h3><i class="fas fa-user"></i> Personal Information</h3>
                            
                            <div class="form-group">
                                <label for="full_name">Full Name</label>
                                <input type="text" id="full_name" name="full_name" 
                                    value="<?php echo htmlspecialchars($admin['full_name'] ?? ''); ?>" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" name="email" 
                                    value="<?php echo htmlspecialchars($admin['email'] ?? ''); ?>" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" name="phone" 
                                    value="<?php echo htmlspecialchars($admin['phone'] ?? ''); ?>" 
                                    placeholder="Optional">
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" name="update_profile" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Password Card -->
                <div class="profile-card">
                    <form method="POST" action="">
                        <div class="form-section">
                            <h3><i class="fas fa-lock"></i> Change Password</h3>
                            
                            <div class="form-group">
                                <label for="current_password">Current Password</label>
                                <input type="password" id="current_password" name="current_password" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="new_password">New Password</label>
                                <input type="password" id="new_password" name="new_password" 
                                    placeholder="Minimum 8 characters" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirm_password">Confirm Password</label>
                                <input type="password" id="confirm_password" name="confirm_password" required>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" name="change_password" class="btn btn-primary">
                                    <i class="fas fa-key"></i> Change Password
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Account Info Card -->
                <div class="profile-card">
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> Account Information</h3>
                        
                        <div class="form-group">
                            <label>User ID:</label>
                            <input type="text" value="<?php echo htmlspecialchars($admin['user_id'] ?? ''); ?>" disabled>
                        </div>
                        
                        <div class="form-group">
                            <label>Account Created:</label>
                            <input type="text" value="<?php echo isset($admin['created_at']) ? date('F d, Y H:i', strtotime($admin['created_at'])) : 'N/A'; ?>" disabled>
                        </div>
                        
                        <div class="form-group">
                            <label>Account Status:</label>
                            <input type="text" value="<?php echo ($admin['is_active'] ?? 1) ? 'Active' : 'Inactive'; ?>" disabled>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
</body>
</html>

C:\wamp64\www\BookIT\admin\get_unit_details.php
<?php
// get_unit_details.php
include '../includes/session.php';
include '../includes/functions.php';
include_once '../config/db.php';
checkRole(['admin']);

if (!isset($_GET['unit_id'])) {
    echo '<div class="alert alert-danger">Unit ID is required</div>';
    exit;
}

$unit_id = (int)$_GET['unit_id'];

// Fetch unit details
$unit = get_single_result("
    SELECT u.*, b.branch_name, b.location, b.address
    FROM units u 
    LEFT JOIN branches b ON u.branch_id = b.branch_id 
    WHERE u.unit_id = ?
", [$unit_id]);

if (!$unit) {
    echo '<div class="alert alert-danger">Unit not found</div>';
    exit;
}

// Fetch performance metrics
$metrics = get_single_result("
    SELECT 
        COUNT(*) as total_bookings,
        COUNT(CASE WHEN status IN ('confirmed', 'checked_in') THEN 1 END) as active_bookings,
        COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed_bookings,
        SUM(total_amount) as total_revenue,
        AVG(rating) as avg_rating
    FROM reservations 
    WHERE unit_id = ?
", [$unit_id]);

// Fetch recent bookings
$recent_bookings = get_multiple_results("
    SELECT r.reservation_id, r.check_in_date, r.check_out_date, r.status, r.total_amount, u.user_name
    FROM reservations r 
    LEFT JOIN users u ON r.user_id = u.user_id 
    WHERE r.unit_id = ? 
    ORDER BY r.created_at DESC 
    LIMIT 5
", [$unit_id]);

// Calculate metrics
$occupancy_rate = $metrics['total_bookings'] > 0 ? 
    min(round(($metrics['completed_bookings'] / $metrics['total_bookings']) * 100, 1), 100) : 0;

$avg_booking_value = $metrics['total_bookings'] > 0 ? 
    round($metrics['total_revenue'] / $metrics['total_bookings'], 2) : 0;

// Calculate additional stats
$total_nights = get_single_result("
    SELECT SUM(DATEDIFF(check_out_date, check_in_date)) as total_nights 
    FROM reservations 
    WHERE unit_id = ? AND status = 'completed'
", [$unit_id]);

$total_nights = $total_nights['total_nights'] ?? 0;
?>

<!-- Unit Header with Gradient -->
<div class="unit-header-gradient rounded-top p-4 mb-0 text-white">
    <div class="row align-items-center">
        <div class="col-md-8">
            <div class="d-flex align-items-center mb-2">
                <h3 class="mb-0 me-3"><?= htmlspecialchars($unit['unit_number']) ?></h3>
                <span class="badge status-badge-lg <?= $unit['is_available'] ? 'bg-success' : 'bg-warning' ?>">
                    <i class="fas fa-circle me-1" style="font-size: 8px;"></i>
                    <?= $unit['is_available'] ? 'AVAILABLE' : 'OCCUPIED' ?>
                </span>
            </div>
            <p class="mb-1">
                <i class="fas fa-home me-2"></i><?= htmlspecialchars($unit['unit_type']) ?>
            </p>
            <p class="mb-0 opacity-75">
                <i class="fas fa-map-marker-alt me-2"></i><?= htmlspecialchars($unit['branch_name']) ?> • <?= htmlspecialchars($unit['location'] ?? $unit['address'] ?? '') ?>
            </p>
        </div>
        <div class="col-md-4 text-end">
            <div class="price-display">
                <div class="price-amount">₱<?= number_format($unit['price'], 2) ?></div>
                <div class="price-period">per night</div>
            </div>
        </div>
    </div>
</div>

<div class="modal-body-content p-4">
    <div class="row">
        <!-- Left Column - Unit Information -->
        <div class="col-lg-6">
            <!-- Unit Specifications Card -->
            <div class="info-card mb-4">
                <div class="card-header-custom">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Unit Specifications
                    </h5>
                </div>
                <div class="card-body-custom">
                    <div class="specs-grid">
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <div class="spec-info">
                                <div class="spec-label">Floor</div>
                                <div class="spec-value"><?= $unit['floor_number'] ?? 'N/A' ?></div>
                            </div>
                        </div>
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="spec-info">
                                <div class="spec-label">Capacity</div>
                                <div class="spec-value"><?= $unit['max_occupancy'] ?> persons</div>
                            </div>
                        </div>
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="spec-info">
                                <div class="spec-label">Security Deposit</div>
                                <div class="spec-value">₱<?= number_format($unit['security_deposit'], 2) ?></div>
                            </div>
                        </div>
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="spec-info">
                                <div class="spec-label">Created</div>
                                <div class="spec-value"><?= date('M j, Y', strtotime($unit['created_at'])) ?></div>
                            </div>
                        </div>
                    </div>

                    <?php if (!empty($unit['description'])): ?>
                    <div class="description-section mt-4">
                        <h6 class="section-title">
                            <i class="fas fa-file-alt me-2"></i>Description
                        </h6>
                        <p class="description-text"><?= nl2br(htmlspecialchars($unit['description'])) ?></p>
                    </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="info-card">
                <div class="card-header-custom">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Quick Stats
                    </h5>
                </div>
                <div class="card-body-custom">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number text-primary"><?= $total_nights ?></div>
                            <div class="stat-label">Total Nights</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number text-success"><?= $metrics['active_bookings'] ?></div>
                            <div class="stat-label">Active Bookings</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number text-info"><?= $metrics['completed_bookings'] ?></div>
                            <div class="stat-label">Completed Stays</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number text-warning"><?= $metrics['total_bookings'] ?></div>
                            <div class="stat-label">Total Bookings</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Performance & Bookings -->
        <div class="col-lg-6">
            <!-- Performance Metrics -->
            <div class="info-card mb-4">
                <div class="card-header-custom">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Performance Overview
                    </h5>
                </div>
                <div class="card-body-custom">
                    <div class="performance-metrics-grid">
                        <div class="metric-card revenue">
                            <div class="metric-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value">₱<?= number_format($metrics['total_revenue'] ?? 0, 2) ?></div>
                                <div class="metric-label">Total Revenue</div>
                            </div>
                        </div>
                        <div class="metric-card occupancy">
                            <div class="metric-icon">
                                <i class="fas fa-bed"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value"><?= $occupancy_rate ?>%</div>
                                <div class="metric-label">Occupancy Rate</div>
                            </div>
                        </div>
                        <div class="metric-card value">
                            <div class="metric-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value">₱<?= number_format($avg_booking_value, 2) ?></div>
                                <div class="metric-label">Avg Booking Value</div>
                            </div>
                        </div>
                        <?php if ($metrics['avg_rating']): ?>
                        <div class="metric-card rating">
                            <div class="metric-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value"><?= number_format($metrics['avg_rating'], 1) ?></div>
                                <div class="metric-label">Average Rating</div>
                            </div>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>
            </div>

            <!-- Recent Bookings -->
            <div class="info-card">
                <div class="card-header-custom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Recent Bookings
                    </h5>
                    <span class="badge bg-primary"><?= count($recent_bookings) ?></span>
                </div>
                <div class="card-body-custom">
                    <?php if ($recent_bookings): ?>
                        <div class="bookings-list">
                            <?php foreach ($recent_bookings as $booking): ?>
                            <div class="booking-item">
                                <div class="booking-header">
                                    <div class="guest-name">
                                        <i class="fas fa-user me-2"></i>
                                        <?= htmlspecialchars($booking['user_name'] ?: 'Guest') ?>
                                    </div>
                                    <span class="booking-status badge bg-<?= 
                                        $booking['status'] === 'confirmed' ? 'success' : 
                                        ($booking['status'] === 'checked_in' ? 'primary' : 
                                        ($booking['status'] === 'completed' ? 'secondary' : 'warning'))
                                    ?>">
                                        <?= ucfirst($booking['status']) ?>
                                    </span>
                                </div>
                                <div class="booking-dates">
                                    <small>
                                        <i class="fas fa-calendar me-1"></i>
                                        <?= date('M j, Y', strtotime($booking['check_in_date'])) ?> - 
                                        <?= date('M j, Y', strtotime($booking['check_out_date'])) ?>
                                    </small>
                                </div>
                                <div class="booking-footer">
                                    <div class="booking-amount">
                                        ₱<?= number_format($booking['total_amount'], 2) ?>
                                    </div>
                                    <div class="booking-id">
                                        #B<?= str_pad($booking['reservation_id'], 4, '0', STR_PAD_LEFT) ?>
                                    </div>
                                </div>
                            </div>
                            <?php endforeach; ?>
                        </div>
                    <?php else: ?>
                        <div class="empty-state">
                            <i class="fas fa-calendar-times fa-2x text-muted mb-3"></i>
                            <p class="text-muted mb-0">No bookings yet</p>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom Styles for View Modal */
.unit-header-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-bottom: 1px solid #dee2e6;
}

.status-badge-lg {
    font-size: 12px;
    padding: 8px 16px;
    border-radius: 20px;
}

.price-display {
    text-align: center;
}

.price-amount {
    font-size: 28px;
    font-weight: 800;
    line-height: 1;
}

.price-period {
    font-size: 14px;
    opacity: 0.9;
    margin-top: 4px;
}

.modal-body-content {
    background: #f8f9fa;
}

.info-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    overflow: hidden;
}

.card-header-custom {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}

.card-header-custom h5 {
    color: #2c3e50;
    font-weight: 600;
}

.card-body-custom {
    padding: 20px;
}

/* Specifications Grid */
.specs-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.spec-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.spec-item:hover {
    background: #e9ecef;
    transform: translateY(-2px);
}

.spec-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #3498db, #2980b9);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.spec-label {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
}

.spec-value {
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
}

/* Description Section */
.section-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 12px;
}

.description-text {
    color: #6c757d;
    line-height: 1.6;
    margin: 0;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.stat-item {
    text-align: center;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
}

.stat-number {
    font-size: 24px;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
}

/* Performance Metrics */
.performance-metrics-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.metric-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    border-radius: 12px;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.metric-card.revenue { border-left: 4px solid #27ae60; }
.metric-card.occupancy { border-left: 4px solid #3498db; }
.metric-card.value { border-left: 4px solid #f39c12; }
.metric-card.rating { border-left: 4px solid #e74c3c; }

.metric-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
}

.metric-card.revenue .metric-icon { background: #27ae60; }
.metric-card.occupancy .metric-icon { background: #3498db; }
.metric-card.value .metric-icon { background: #f39c12; }
.metric-card.rating .metric-icon { background: #e74c3c; }

.metric-value {
    font-size: 18px;
    font-weight: 700;
    color: #2c3e50;
    line-height: 1;
    margin-bottom: 4px;
}

.metric-label {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
}

/* Bookings List */
.bookings-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.booking-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    border-left: 4px solid #3498db;
    transition: all 0.3s ease;
}

.booking-item:hover {
    background: #e9ecef;
    transform: translateX(4px);
}

.booking-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 8px;
}

.guest-name {
    font-weight: 600;
    color: #2c3e50;
    flex: 1;
}

.booking-dates {
    margin-bottom: 8px;
}

.booking-footer {
    display: flex;
    justify-content: between;
    align-items: center;
}

.booking-amount {
    font-weight: 700;
    color: #27ae60;
}

.booking-id {
    font-size: 11px;
    color: #6c757d;
    font-weight: 500;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}

/* Responsive Design */
@media (max-width: 768px) {
    .specs-grid,
    .stats-grid,
    .performance-metrics-grid {
        grid-template-columns: 1fr;
    }
    
    .booking-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .price-amount {
        font-size: 24px;
    }
}
</style>

C:\wamp64\www\BookIT\admin\manage_branch.php
<?php
    // BookIT Branch Management
    // Multi-branch Condo Rental Reservation System

    include '../includes/session.php';
    include '../includes/functions.php';
    include_once '../config/db.php';
    checkRole(['admin']); // Tanging admin lang ang pwede

    $message = '';
    $error = '';

    // Check for session messages from previous redirect
    if (isset($_SESSION['success_message'])) {
        $message = $_SESSION['success_message'];
        unset($_SESSION['success_message']);
    }
    if (isset($_SESSION['error_message'])) {
        $error = $_SESSION['error_message'];
        unset($_SESSION['error_message']);
    }

    // Handle form submissions
    if ($_SERVER['REQUEST_METHOD'] == 'POST') {
        if (isset($_POST['add_branch'])) {
            // Mag-add ng bagong branch
            $branch_name = sanitize_input($_POST['branch_name']);
            $address = sanitize_input($_POST['address']);
            $city = sanitize_input($_POST['city']);
            $contact_number = sanitize_input($_POST['contact_number']);
            $email = sanitize_input($_POST['email']);
            $host_id = !empty($_POST['host_id']) ? $_POST['host_id'] : null;
            
            $result = addBranch($branch_name, $address, $city, $contact_number, $email, $host_id);
            
            // Store message in session so it survives the redirect
            if (strpos($result, 'successfully') !== false) {
                $_SESSION['success_message'] = $result;
            } else {
                $_SESSION['error_message'] = $result;
            }
            
            // Refresh page to show new branch
            header("Location: manage_branch.php");
            exit();
        }
        
        if (isset($_POST['update_branch'])) {
            // Mag-update ng existing branch
            $branch_id = $_POST['branch_id'];
            $branch_name = sanitize_input($_POST['branch_name']);
            $address = sanitize_input($_POST['address']);
            $city = sanitize_input($_POST['city']);
            $contact_number = sanitize_input($_POST['contact_number']);
            $email = sanitize_input($_POST['email']);
            $host_id = !empty($_POST['host_id']) ? $_POST['host_id'] : null;
            
            $sql = "UPDATE branches SET branch_name = ?, address = ?, city = ?, contact_number = ?, email = ?, host_id = ? WHERE branch_id = ?";
            if (execute_query($sql, [$branch_name, $address, $city, $contact_number, $email, $host_id, $branch_id])) {
                $_SESSION['success_message'] = "Branch updated successfully!";
            } else {
                $_SESSION['error_message'] = "Failed to update branch!";
            }
            header("Location: manage_branch.php");
            exit();
        }
        
        // I-update ang delete_branch handler
if (isset($_POST['delete_branch'])) {
    // Mag-delete ng branch (soft delete) at i-update ang mga units
    $branch_id = $_POST['branch_id'];
    
    try {
        // Start transaction
        $conn->begin_transaction();
        
        // 1. I-soft delete ang branch
        $sql = "UPDATE branches SET is_active = 0 WHERE branch_id = ?";
        if (!execute_query($sql, [$branch_id])) {
            throw new Exception("Failed to deactivate branch");
        }
        
        // 2. I-deactivate ang lahat ng units sa branch na ito
        $sql = "UPDATE units SET is_available = 0 WHERE branch_id = ?";
        if (!execute_query($sql, [$branch_id])) {
            throw new Exception("Failed to deactivate units");
        }
        
        // 3. I-cancel ang lahat ng active reservations sa branch na ito
        $sql = "UPDATE reservations SET status = 'cancelled' 
                WHERE branch_id = ? AND status IN ('pending', 'confirmed')";
        if (!execute_query($sql, [$branch_id])) {
            throw new Exception("Failed to cancel reservations");
        }
        
        $conn->commit();
        $_SESSION['success_message'] = "Branch and all associated units deactivated successfully!";
        
    } catch (Exception $e) {
        $conn->rollback();
        $_SESSION['error_message'] = "Failed to deactivate branch: " . $e->getMessage();
    }
    
    header("Location: manage_branch.php");
    exit();
}
    } // End of POST handling

    // ==================== FETCH BRANCHES WITH PERFORMANCE METRICS ====================
    $branches = [];
    try {
        $sql = "SELECT b.*, 
                    u.full_name as host_name,
                    (SELECT COUNT(*) FROM units WHERE branch_id = b.branch_id) as unit_count,
                    (SELECT COUNT(*) FROM users WHERE branch_id = b.branch_id AND role = 'host') as staff_count,
                    (SELECT COUNT(*) FROM reservations WHERE branch_id = b.branch_id) as total_bookings,
                    (SELECT COUNT(DISTINCT unit_id) FROM reservations WHERE branch_id = b.branch_id AND status IN ('confirmed', 'checked_in')) as booked_units,
                    (SELECT SUM(total_amount) FROM reservations WHERE branch_id = b.branch_id AND status IN ('confirmed', 'checked_in', 'completed')) as total_revenue,
                    b.created_at as last_activity
                FROM branches b
                LEFT JOIN users u ON b.host_id = u.user_id
                WHERE b.is_active = 1
                ORDER BY b.created_at DESC";
        
        $result = $conn->query($sql);
        if ($result) {
            while ($row = $result->fetch_assoc()) {
                // Calculate performance metrics
                $row['occupancy_rate'] = $row['unit_count'] > 0 ? 
                    min(round(($row['booked_units'] / $row['unit_count']) * 100, 1), 100) : 0;
                $row['avg_booking_value'] = $row['total_bookings'] > 0 ? 
                    round($row['total_revenue'] / $row['total_bookings'], 2) : 0;
                
                $branches[] = $row;
            }
        }
    } catch (Exception $e) {
        $error = $e->getMessage();
    }

    // Kumuha ng available hosts
    $hosts = get_multiple_results("SELECT user_id, full_name FROM users WHERE role = 'host' AND is_active = 1");

    // Get pending verifications count
    $pending_count = 0;

    // Handle hosts result
    $hosts_data = [];
    if (is_object($hosts)) {
        $hosts_data = $hosts;
    } elseif (is_array($hosts)) {
        $hosts_data = $hosts;
    }

    // Calculate overall statistics
    $total_revenue = array_sum(array_column($branches, 'total_revenue'));
    $total_bookings = array_sum(array_column($branches, 'total_bookings'));
    $avg_occupancy = count($branches) > 0 ? round(array_sum(array_column($branches, 'occupancy_rate')) / count($branches), 1) : 0;
    ?>

    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <title>Branch Management - BookIT</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <link href="../assets/css/sidebar-common.css" rel="stylesheet">
        <link href="../assets/css/admin/manage_branch.css" rel="stylesheet">
        <link href="../assets/css/modals.css" rel="stylesheet">
        <!-- DataTables -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
    </head>
    <body>

    <div class="d-flex">
        <!-- Sidebar -->
        <?php include '../includes/sidebar.php'; ?>

        <main class="main-content flex-grow-1">
        <div class="page-header">
            <div>
                <h1 class="page-title mb-1">
                    <i class="fas fa-building me-2"></i>Branch Management
                </h1>
                <p class="text-muted">Manage all branch locations and their operations</p>
            </div>
            <div class="page-actions">
                <button type="button" class="btn-refresh" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button type="button" class="btn-export" onclick="exportBranches('pdf')">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <button type="button" class="btn-export" onclick="exportBranches('csv')">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button type="button" class="btn-add" data-bs-toggle="modal" data-bs-target="#addBranchModal">
                    <i class="fas fa-plus"></i> Add Branch
                </button>
            </div>
        </div>

        <!-- Messages -->
        <?php if ($message): ?>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i> <?php echo $message; ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <?php endif; ?>

        <?php if ($error): ?>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle"></i> <?php echo $error; ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <?php endif; ?>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card">
                <div class="card-icon"><i class="fas fa-building"></i></div>
                <div class="card-info">
                    <h3><?= count($branches) ?></h3>
                    <p>Total Branches</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                <div class="card-info">
                    <h3><?= $avg_occupancy ?>%</h3>
                    <p>Avg Occupancy Rate</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="card-info">
                    <h3><?= $total_bookings ?></h3>
                    <p>Total Bookings</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-money-bill-wave"></i></div>
                <div class="card-info">
                    <h3>₱<?= number_format($total_revenue, 2) ?></h3>
                    <p>Total Revenue</p>
                </div>
            </div>
        </div>

        <!-- Branches Table -->
        <div class="table-card">
            <div class="table-header">
                <div class="table-title">Branch Details & Performance</div>
            </div>
            <table id="branchesTable" class="display table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Branch Name</th>
                        <th>Location</th>
                        <th>Host</th>
                        <th>Performance</th>
                        <th>Units</th>
                        <th>Bookings</th>
                        <th>Revenue</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($branches as $branch): ?>
    <tr>
        <td>#B<?= str_pad($branch['branch_id'], 4, '0', STR_PAD_LEFT) ?></td>
        <td>
            <strong><?= htmlspecialchars($branch['branch_name']) ?></strong><br>
            <small class="text-muted"><?= htmlspecialchars($branch['email']) ?></small>
        </td>
        <td>
            <?= htmlspecialchars($branch['city']) ?><br>
            <small class="text-muted"><?= htmlspecialchars($branch['contact_number']) ?></small>
        </td>
        <td>
            <?php if ($branch['host_name']): ?>
                <span class="badge badge-success"><?= htmlspecialchars($branch['host_name']) ?></span>
            <?php else: ?>
                <span class="badge badge-secondary">Not Assigned</span>
            <?php endif; ?>
        </td>
        <td>
            <div class="performance-metrics">
                <div class="occupancy-rate">
                    <span class="rate-value"><?= $branch['occupancy_rate'] ?>%</span>
                    <small>Occupancy</small>
                </div>
                <div class="progress" style="height: 5px; width: 80px;">
                    <div class="progress-bar <?= $branch['occupancy_rate'] >= 70 ? 'bg-success' : ($branch['occupancy_rate'] >= 40 ? 'bg-warning' : 'bg-danger') ?>" 
                        style="width: <?= $branch['occupancy_rate'] ?>%">
                    </div>
                </div>
            </div>
        </td>
        <td>
            <span class="badge badge-info">
                <?= $branch['unit_count'] ?> Units
        </span>
        </td>
        <td>
            <span class="badge badge-primary">
                <?= $branch['total_bookings'] ?> Bookings
            </span>
        </td>
        <td>
            <span class="revenue-amount">
                ₱<?= number_format($branch['total_revenue'] ?? 0, 2) ?>
            </span>
        </td>
        <td>
            <div class="action-buttons">
                <button type="button" class="btn-view" 
                        data-bs-toggle="modal" 
                        data-bs-target="#viewBranchModal"
                        onclick="viewBranch(<?php echo htmlspecialchars(json_encode($branch)); ?>)" 
                        title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button type="button" class="btn-edit" 
                        data-bs-toggle="modal" 
                        data-bs-target="#editBranchModal"
                        onclick="editBranch(<?php echo htmlspecialchars(json_encode($branch)); ?>)" 
                        title="Edit Branch">
                    <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn-delete" 
                        onclick="confirmDelete(<?= $branch['branch_id'] ?>, '<?= $branch['branch_name'] ?>')" 
                        title="Delete Branch">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    </tr>
    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </main>
    </div>    <?php foreach ($branches as $branch): ?>
        <tr>
            <!-- Branch data displays here -->
        </tr>
    <?php endforeach; ?>

    <!-- Add Branch Modal -->
    <div class="modal fade" id="addBranchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Branch</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Branch Name *</label>
                            <input type="text" class="form-control" name="branch_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Address *</label>
                            <textarea class="form-control" name="address" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">City *</label>
                            <input type="text" class="form-control" name="city" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contact Number</label>
                            <input type="text" class="form-control" name="contact_number">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Host</label>
                            <select class="form-select" name="host_id">
                                <option value="">Select Host (Optional)</option>
                                <?php 
                                if (is_object($hosts_data)) {
                                    $host->data_seek(0); // Reset pointer
                                    while ($host = $hosts_data->fetch_assoc()): 
                                ?>
                                    <option value="<?php echo $host['user_id']; ?>">
                                        <?php echo $host['full_name']; ?>
                                    </option>
                                <?php endwhile; 
                                } elseif (is_array($hosts_data)) {
                                    foreach ($hosts_data as $host): 
                                ?>
                                    <option value="<?php echo $host['user_id']; ?>">
                                        <?php echo $host['full_name']; ?>
                                    </option>
                                <?php endforeach; 
                                } ?>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="add_branch" class="btn btn-primary">
                            <i class="fas fa-save"></i> Add Branch
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Branch Modal -->
    <div class="modal fade" id="editBranchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST">
                    <input type="hidden" name="branch_id" id="edit_branch_id">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Branch</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Branch Name *</label>
                            <input type="text" class="form-control" name="branch_name" id="edit_branch_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Address *</label>
                            <textarea class="form-control" name="address" id="edit_address" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">City *</label>
                            <input type="text" class="form-control" name="city" id="edit_city" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contact Number</label>
                            <input type="text" class="form-control" name="contact_number" id="edit_contact_number">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="edit_email">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">host</label>
                            <select class="form-select" name="host_id" id="edit_host_id">
                                <option value="">Select host (Optional)</option>
                                <?php 
                                if (is_object($hosts_data)) {
                                    $hosts_data->data_seek(0); // Reset pointer
                                    while ($host = $hosts_data->fetch_assoc()): 
                                ?>
                                    <option value="<?php echo $host['user_id']; ?>">
                                        <?php echo $host['full_name']; ?>
                                    </option>
                                <?php endwhile; 
                                } elseif (is_array($hosts_data)) {
                                    foreach ($hosts_data as $host): 
                                ?>
                                    <option value="<?php echo $host['user_id']; ?>">
                                        <?php echo $host['full_name']; ?>
                                    </option>
                                <?php endforeach; 
                                } ?>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="update_branch" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update Branch
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Branch Modal -->
    <div class="modal fade" id="viewBranchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-eye"></i> Branch Details & Performance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewBranchDetails">
                    <!-- Branch details will be populated via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST">
                    <input type="hidden" name="branch_id" id="delete_branch_id">
                    <div class="modal-header">
                        <h5 class="modal-title text-danger"><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to deactivate this branch?</p>
                        <p><strong>Branch:</strong> <span id="delete_branch_name"></span></p>
                        <p class="text-muted">This action will deactivate the branch and make it unavailable for new reservations.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="delete_branch" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Deactivate Branch
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Required Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="../assets/js/admin/manage_branch.js"></script>
    </body>
    </html>


C:\wamp64\www\BookIT\admin\reports.php
<?php
// Admin Printable Reports
// Include your shared database connection file
include_once __DIR__ . '/../config/db.php';
include_once __DIR__ . '/../includes/session.php';
include_once __DIR__ . '/../includes/functions.php';
checkRole(['admin']);

// -----------------------------
// Variables
// -----------------------------
$useDb = isset($conn) && $conn instanceof mysqli;
$mysqli = $useDb ? $conn : null;
$generatedDate = date("F d, Y h:i A");
$superadminName = $_SESSION['fullname'] ?? "System Superadmin";
// Print mode flag (used for body class and to skip sidebar)
$isPrint = isset($_GET['print']) && $_GET['print'] === '1';

// -----------------------------
// Load Data (with fallbacks)
// -----------------------------
if ($useDb) {
    try {
        // Users: fetch from users table with proper columns
        $users = fetch_all($mysqli, "SELECT 
            user_id as id, 
            full_name as name, 
            email, 
            role, 
            is_active,
            (SELECT branch_name FROM branches WHERE branch_id = users.branch_id) AS branch
            FROM users ORDER BY full_name");

        // Branches: include computed units_count
        $branches = fetch_all($mysqli, "SELECT 
            branch_id as id, 
            branch_name as name, 
            is_active,
            city as location,
            (SELECT COUNT(*) FROM units WHERE branch_id = branches.branch_id) AS units_count
            FROM branches ORDER BY branch_name");

        // Units - using the actual structure from your functions.php
        // Since there's no price column in units table, we'll use 0 as default
        $units = fetch_all($mysqli, "SELECT 
            unit_id as id, 
            unit_number as title, 
            unit_type as type,
            unit_number as property, 
            (SELECT branch_name FROM branches WHERE branch_id = units.branch_id) AS location,
            0 as price, -- Default price since no price column exists
            is_available,
            created_at
            FROM units ORDER BY unit_id DESC");

        // Reservations - kasama na ang created_at timestamp
        $reservations = fetch_all($mysqli, "SELECT 
            r.reservation_id as id,
            u.full_name as customer,
            un.unit_number,
            b.branch_name as location,
            r.check_in_date,
            r.check_out_date,
            r.total_amount as price,
            r.status,
            r.created_at
            FROM reservations r
            JOIN users u ON r.user_id = u.user_id
            JOIN units un ON r.unit_id = un.unit_id
            JOIN branches b ON r.branch_id = b.branch_id
            ORDER BY r.created_at DESC");

    } catch (Exception $e) {
        // If any database error occurs, use fallback data
        error_log("Database error in reports: " . $e->getMessage());
        $useDb = false;
    }
}

// If database failed, use fallback data
if (!$useDb) {
    // Fallback data
    $users = [
        ["id"=>"U001","name"=>"John Doe","email"=>"john@example.com","role"=>"Admin","branch"=>"Main","is_active"=>"1"],
    ];
    $branches = [
        ["id"=>"B001","name"=>"Central Branch","is_active"=>"1","location"=>"Makati","units_count"=>5],
    ];
    $units = [
        ["id"=>"U001","title"=>"Unit 101","type"=>"Studio","property"=>"Unit 101","location"=>"Central Branch","price"=>"₱5,000","is_available"=>"1","created_at"=>"2025-11-01"],
    ];
    $reservations = [
        ["id"=>"R001","customer"=>"John Doe","unit_number"=>"Unit 101","location"=>"Central Branch","check_in_date"=>"2025-12-01","check_out_date"=>"2025-12-05","price"=>"₱20,000","status"=>"confirmed","created_at"=>"2025-11-15 14:30:25"],
    ];
}
?>
<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <title>Branch Management</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <link rel="stylesheet" href="../assets/css/admin/reports.css">
        <!-- DataTables -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
    </head>
    <body>
    <!-- =================== BUILT-IN SIDEBAR =================== -->
    <aside class="sidebar" id="sidebar">
    <div class="brand">
      <i class="fas fa-building"></i>
      <span>BookIT Admin</span>
    </div>
        <nav class="sidebar-menu">
            <ul>
                <li><a href="<?php echo SITE_URL; ?>/admin/admin_dashboard.php"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/admin/manage_branch.php"><i class="fas fa-code-branch"></i><span>Branch Management</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/admin/user_management.php"><i class="fas fa-users"></i> <span>User Management</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/admin/unit_management.php"><i class="fas fa-home"></i> <span>Unit Management</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/modules/reservations.php"><i class="fas fa-calendar-check"></i> <span>Reservation Management</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/modules/payment_management.php"><i class="fas fa-credit-card"></i> <span>Payment Management</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/admin/amenity_management.php"><i class="fas fa-swimming-pool"></i> <span>Amenity Management</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/admin/reports.php" class="active"><i class="fas fa-chart-line"></i> <span>Reports</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/admin/settings.php"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
            </ul>
        </nav>

    <!-- =================== PROFILE SECTION =================== -->
        <div class="sidebar-profile">
            <div class="profile-info">
                <div class="profile-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="profile-details">
                    <span class="profile-name"><?php echo htmlspecialchars($_SESSION['fullname'] ?? 'Admin'); ?></span>
                    <span class="profile-role"><?php echo htmlspecialchars(ucfirst($_SESSION['role'] ?? 'Admin')); ?></span>
                </div>
            </div>
            <a href="<?php echo SITE_URL; ?>/public/logout.php" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
            </a>
        </div>
</aside>

<main class="content">
        <div id="printableArea">
            <!-- Report Header -->
            <div class="report-header">
                <div class="report-title">
                    <h1><i class="fas fa-chart-line"></i> Admin Reports</h1>
                    <div class="report-meta">
                        Generated: <?= esc($generatedDate) ?> | 
                        Admin: <?= esc($superadminName) ?>
                    </div>
                </div>
                <div class="report-actions no-print">
                    <button class="btn-print" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                    <button class="btn-print" onclick="window.location.href='?print=1'">
                        <i class="fas fa-file-pdf"></i> Print View
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-number"><?= count($users) ?></div>
                    <div class="summary-label">Total Users</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number"><?= count($branches) ?></div>
                    <div class="summary-label">Total Branches</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number"><?= count($units) ?></div>
                    <div class="summary-label">Total Units</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number"><?= count($reservations) ?></div>
                    <div class="summary-label">Total Reservations</div>
                </div>
            </div>

            <!-- Search Box -->
            <div class="search-box no-print">
                <input type="search" id="globalSearch" placeholder="Search across all reports..." class="form-control">
            </div>

            <!-- Users Section -->
            <div class="section-module">
                <h2><i class="fas fa-users"></i> Users Management</h2>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Branch</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach($users as $r): ?>
                            <tr>
                                <td>#U<?= str_pad($r['id'], 4, '0', STR_PAD_LEFT) ?></td>
                                <td><?= esc($r['name']) ?></td>
                                <td><?= esc($r['email']) ?></td>
                                <td>
                                    <span class="badge badge-<?= $r['role'] === 'admin' ? 'active' : ($r['role'] === 'manager' ? 'pending' : 'confirmed') ?>">
                                        <?= esc($r['role']) ?>
                                    </span>
                                </td>
                                <td><?= esc($r['branch'] ?? 'N/A') ?></td>
                                <td>
                                    <span class="badge badge-<?= $r['is_active'] ? 'active' : 'inactive' ?>">
                                        <?= $r['is_active'] ? 'Active' : 'Inactive' ?>
                                    </span>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Branches Section -->
            <div class="section-module">
                <h2><i class="fas fa-code-branch"></i> Branches Management</h2>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Location</th>
                                <th>Units Count</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach($branches as $r): ?>
                            <tr>
                                <td>#B<?= str_pad($r['id'], 4, '0', STR_PAD_LEFT) ?></td>
                                <td><?= esc($r['name']) ?></td>
                                <td><?= esc($r['location']) ?></td>
                                <td><?= esc($r['units_count']) ?></td>
                                <td>
                                    <span class="badge badge-<?= $r['is_active'] ? 'active' : 'inactive' ?>">
                                        <?= $r['is_active'] ? 'Active' : 'Inactive' ?>
                                    </span>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Units Section -->
            <div class="section-module">
                <h2><i class="fas fa-home"></i> Units Management</h2>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Unit Number</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach($units as $r): ?>
                            <tr>
                                <td>#UN<?= str_pad($r['id'], 4, '0', STR_PAD_LEFT) ?></td>
                                <td><?= esc($r['title']) ?></td>
                                <td><?= esc($r['type']) ?></td>
                                <td><?= esc($r['location']) ?></td>
                                <td>₱<?= number_format($r['price'] ?? 0, 2) ?></td>
                                <td>
                                    <span class="badge badge-<?= $r['is_available'] ? 'active' : 'inactive' ?>">
                                        <?= $r['is_available'] ? 'Available' : 'Occupied' ?>
                                    </span>
                                </td>
                                <td><?= date('M d, Y', strtotime($r['created_at'])) ?></td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reservations Section -->
            <div class="section-module">
                <h2><i class="fas fa-calendar-check"></i> Reservations Management</h2>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Unit</th>
                                <th>Location</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Reserved At</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach($reservations as $r): ?>
                            <tr>
                                <td>#R<?= str_pad($r['id'], 4, '0', STR_PAD_LEFT) ?></td>
                                <td><?= esc($r['customer']) ?></td>
                                <td><?= esc($r['unit_number']) ?></td>
                                <td><?= esc($r['location']) ?></td>
                                <td><?= date('M d, Y', strtotime($r['check_in_date'])) ?></td>
                                <td><?= date('M d, Y', strtotime($r['check_out_date'])) ?></td>
                                <td>₱<?= number_format($r['price'] ?? 0, 2) ?></td>
                                <td>
                                    <span class="badge badge-<?= $r['status'] === 'confirmed' ? 'confirmed' : 'pending' ?>">
                                        <?= ucfirst($r['status']) ?>
                                    </span>
                                </td>
                                <td>
                                    <div><?= date('M d, Y', strtotime($r['created_at'])) ?></div>
                                    <div class="reservation-time"><?= date('h:i A', strtotime($r['created_at'])) ?></div>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Report Footer -->
            <div class="report-footer">
                "The Admin has full system-wide access and control over all users, branches, units, and reservations for monitoring and decision-making."
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/admin/reports.js"></script>
    <script>
        // Auto-print if in print mode
        <?php if ($isPrint): ?>
        window.onload = function() {
            window.print();
            // Redirect back after print
            setTimeout(function() {
                window.location.href = 'reports.php';
            }, 500);
        }
        <?php endif; ?>
    </script>
</body>
</html>

C:\wamp64\www\BookIT\admin\settings.php
<?php
// BookIT Admin Settings
// System Configuration & Management

include '../includes/session.php';
include '../includes/functions.php';
include_once '../config/db.php';
checkRole(['admin']); // Only admin can access

$message = '';
$error = '';
$active_tab = $_GET['tab'] ?? 'general';

// Helper function to update setting in database
function updateSetting($key, $value) {
    global $conn;
    $stmt = $conn->prepare("INSERT INTO system_settings (setting_key, setting_value) VALUES (?, ?) ON DUPLICATE KEY UPDATE setting_value = ?");
    return $stmt->execute([$key, $value, $value]);
}

// Handle form submissions via AJAX
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    header('Content-Type: application/json');
    $response = ['success' => false, 'message' => ''];
    
    // General Settings
    if (isset($_POST['save_general'])) {
        try {
            updateSetting('system_name', sanitize_input($_POST['system_name']));
            updateSetting('company_name', sanitize_input($_POST['company_name']));
            updateSetting('address', sanitize_input($_POST['address']));
            updateSetting('email', sanitize_input($_POST['email']));
            updateSetting('contact_number', sanitize_input($_POST['contact_number']));
            updateSetting('date_format', sanitize_input($_POST['date_format']));
            $response['success'] = true;
            $response['message'] = "General settings updated successfully!";
        } catch (Exception $e) {
            $response['message'] = "Error updating settings: " . $e->getMessage();
        }
    }
    
    // Email Settings
    if (isset($_POST['save_email'])) {
        try {
            updateSetting('sender_email', sanitize_input($_POST['sender_email']));
            updateSetting('smtp_host', sanitize_input($_POST['smtp_host']));
            updateSetting('smtp_port', sanitize_input($_POST['smtp_port']));
            updateSetting('smtp_username', sanitize_input($_POST['smtp_username']));
            updateSetting('smtp_password', sanitize_input($_POST['smtp_password']));
            updateSetting('smtp_encryption', sanitize_input($_POST['smtp_encryption'] ?? 'tls'));
            updateSetting('notif_reservation', isset($_POST['notif_reservation']) ? 'yes' : 'no');
            updateSetting('notif_payment', isset($_POST['notif_payment']) ? 'yes' : 'no');
            updateSetting('notif_review', isset($_POST['notif_review']) ? 'yes' : 'no');
            updateSetting('notif_system', isset($_POST['notif_system']) ? 'yes' : 'no');
            $response['success'] = true;
            $response['message'] = "Email settings updated successfully!";
        } catch (Exception $e) {
            $response['message'] = "Error updating settings: " . $e->getMessage();
        }
    }
    
    // Payment Settings
    if (isset($_POST['save_payment'])) {
        try {
            updateSetting('payment_gcash', isset($_POST['payment_gcash']) ? 'yes' : 'no');
            updateSetting('gcash_account', sanitize_input($_POST['gcash_account'] ?? ''));
            updateSetting('payment_bank', isset($_POST['payment_bank']) ? 'yes' : 'no');
            updateSetting('bank_details', sanitize_input($_POST['bank_details'] ?? ''));
            updateSetting('payment_paypal', isset($_POST['payment_paypal']) ? 'yes' : 'no');
            updateSetting('paypal_account', sanitize_input($_POST['paypal_account'] ?? ''));
            updateSetting('payment_dragonpay', isset($_POST['payment_dragonpay']) ? 'yes' : 'no');
            updateSetting('dragonpay_id', sanitize_input($_POST['dragonpay_id'] ?? ''));
            updateSetting('transaction_fee', sanitize_input($_POST['transaction_fee'] ?? '0'));
            updateSetting('payment_instructions', sanitize_input($_POST['payment_instructions'] ?? ''));
            $response['success'] = true;
            $response['message'] = "Payment settings updated successfully!";
        } catch (Exception $e) {
            $response['message'] = "Error updating settings: " . $e->getMessage();
        }
    }
    
    // Security Settings
    if (isset($_POST['save_security'])) {
        try {
            updateSetting('login_attempts', sanitize_input($_POST['login_attempts']));
            updateSetting('lockout_duration', sanitize_input($_POST['lockout_duration']));
            updateSetting('session_timeout', sanitize_input($_POST['session_timeout'] ?? '60'));
            updateSetting('password_min_length', sanitize_input($_POST['password_min_length']));
            updateSetting('password_expiration', sanitize_input($_POST['password_expiration'] ?? '90'));
            updateSetting('req_uppercase', isset($_POST['req_uppercase']) ? 'yes' : 'no');
            updateSetting('req_lowercase', isset($_POST['req_lowercase']) ? 'yes' : 'no');
            updateSetting('req_numbers', isset($_POST['req_numbers']) ? 'yes' : 'no');
            updateSetting('req_special', isset($_POST['req_special']) ? 'yes' : 'no');
            updateSetting('two_factor', isset($_POST['two_factor']) ? 'yes' : 'no');
            updateSetting('force_https', isset($_POST['force_https']) ? 'yes' : 'no');
            updateSetting('ip_whitelist', isset($_POST['ip_whitelist']) ? 'yes' : 'no');
            $response['success'] = true;
            $response['message'] = "Security settings updated successfully!";
        } catch (Exception $e) {
            $response['message'] = "Error updating settings: " . $e->getMessage();
        }
    }
    
    // Branch Defaults
    if (isset($_POST['save_branch_defaults'])) {
        try {
            updateSetting('default_amenities', sanitize_input($_POST['default_amenities']));
            $response['success'] = true;
            $response['message'] = "Branch defaults updated successfully!";
        } catch (Exception $e) {
            $response['message'] = "Error updating settings: " . $e->getMessage();
        }
    }
    
    // UI Customization
    if (isset($_POST['save_ui'])) {
        try {
            updateSetting('primary_color', sanitize_input($_POST['primary_color'] ?? '#3498db'));
            updateSetting('secondary_color', sanitize_input($_POST['secondary_color'] ?? '#2c3e50'));
            updateSetting('custom_message', sanitize_input($_POST['custom_message']));
            $response['success'] = true;
            $response['message'] = "UI settings updated successfully!";
        } catch (Exception $e) {
            $response['message'] = "Error updating settings: " . $e->getMessage();
        }
    }
    
    echo json_encode($response);
    exit;
}

// Get current settings from database
$settings = [];
try {
    // Fetch all system settings as key-value pairs
    $result = $conn->query("SELECT setting_key, setting_value FROM system_settings");
    if ($result) {
        while ($row = $result->fetch_assoc()) {
            $settings[$row['setting_key']] = $row['setting_value'];
        }
    }
} catch (Exception $e) {
    // Handle error silently - defaults will be used
}

// Helper function to get setting with default value
function getSetting($key, $default = '') {
    global $settings;
    return isset($settings[$key]) ? $settings[$key] : $default;
}

// Get all admins
$admins = get_multiple_results("SELECT user_id, full_name, email, is_active FROM users WHERE role = 'admin' ORDER BY created_at DESC");

// Get all branches
$all_branches = get_multiple_results("SELECT branch_id, branch_name, host_id, (SELECT COUNT(*) FROM units WHERE branch_id = branches.branch_id) as unit_count FROM branches WHERE is_active = 1 ORDER BY branch_name");

// Get all amenities for default list
$all_amenities = get_multiple_results("SELECT DISTINCT amenity_name, description, hourly_rate FROM amenities ORDER BY amenity_name");
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - BookIT Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../assets/css/sidebar-common.css" rel="stylesheet">
    <link href="../assets/css/admin/settings.css" rel="stylesheet">
    <link href="../assets/css/modals.css" rel="stylesheet">
</head>
<body>

<div class="d-flex">
    <!-- Sidebar -->
    <?php include '../includes/sidebar.php'; ?>

    <main class="main-content flex-grow-1">
        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1 class="page-title mb-1">
                    <i class="fas fa-cog me-2"></i>System Settings
                </h1>
                <p class="text-muted">Configure and manage system-wide settings</p>
            </div>
            <div class="page-actions">
                <button type="button" class="btn-refresh" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Messages -->
        <?php if ($message): ?>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i> <?php echo $message; ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <?php endif; ?>

        <?php if ($error): ?>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle"></i> <?php echo $error; ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <?php endif; ?>

        <!-- Settings Navigation Tabs -->
        <div class="settings-nav">
            <div class="nav-tabs">
                <a href="?tab=general" class="nav-tab <?php echo $active_tab == 'general' ? 'active' : ''; ?>">
                    <i class="fas fa-sliders-h"></i> General
                </a>
                <a href="?tab=email" class="nav-tab <?php echo $active_tab == 'email' ? 'active' : ''; ?>">
                    <i class="fas fa-envelope"></i> Email & Notifications
                </a>
                <a href="?tab=payment" class="nav-tab <?php echo $active_tab == 'payment' ? 'active' : ''; ?>">
                    <i class="fas fa-credit-card"></i> Payment
                </a>
                <a href="?tab=security" class="nav-tab <?php echo $active_tab == 'security' ? 'active' : ''; ?>">
                    <i class="fas fa-shield-alt"></i> Security
                </a>
                <a href="?tab=access" class="nav-tab <?php echo $active_tab == 'access' ? 'active' : ''; ?>">
                    <i class="fas fa-users-cog"></i> Access Control
                </a>
                <a href="?tab=data" class="nav-tab <?php echo $active_tab == 'data' ? 'active' : ''; ?>">
                    <i class="fas fa-database"></i> Data Management
                </a>
                <a href="?tab=defaults" class="nav-tab <?php echo $active_tab == 'defaults' ? 'active' : ''; ?>">
                    <i class="fas fa-building"></i> Defaults
                </a>
                <a href="?tab=ui" class="nav-tab <?php echo $active_tab == 'ui' ? 'active' : ''; ?>">
                    <i class="fas fa-palette"></i> UI Customization
                </a>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="settings-content">

            <!-- 1. GENERAL SETTINGS -->
            <?php if ($active_tab == 'general'): ?>
            <div class="settings-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-sliders-h"></i> General Settings</h2>
                    <p>Configure basic system information and preferences</p>
                </div>

                <form method="POST" class="settings-form" id="generalForm">
                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-info-circle"></i> System Information</h5>
                        
                        <div class="form-group">
                            <label class="form-label">System Name / Title</label>
                            <input type="text" class="form-control" name="system_name" value="<?php echo htmlspecialchars(getSetting('system_name', 'BookIT')); ?>" placeholder="e.g., BookIT Rental System">
                            <small class="form-text text-muted">Name displayed in browser tab and header</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" name="company_name" value="<?php echo htmlspecialchars(getSetting('company_name', 'BookIT Management')); ?>" placeholder="e.g., BookIT Management Inc.">
                        </div>

                        <div class="form-group">
                            <label class="form-label">System Logo</label>
                            <div class="logo-upload">
                                <div class="logo-preview">
                                    <img src="../assets/images/logo.png" alt="Logo" id="logoPreview">
                                </div>
                                <div class="logo-controls">
                                    <input type="file" class="form-control" id="logoFile" accept="image/*">
                                    <small class="form-text text-muted">Recommended size: 200x200px</small>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Favicon</label>
                            <input type="file" class="form-control" accept="image/*">
                            <small class="form-text text-muted">Icon that appears in browser tab</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-map-marker-alt"></i> Contact Information</h5>
                        
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" name="address" rows="3" placeholder="Street, City, Province, Postal Code"><?php echo htmlspecialchars(getSetting('address', '')); ?></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" value="<?php echo htmlspecialchars(getSetting('email', '')); ?>">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Contact Number</label>
                            <input type="tel" class="form-control" name="contact_number" value="<?php echo htmlspecialchars(getSetting('contact_number', '')); ?>">
                        </div>
                    </div>

                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-globe"></i> Regional Settings</h5>
                        
                        <div class="form-group">
                            <label class="form-label">Timezone</label>
                            <div class="form-control" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px 12px; border-radius: 8px;">
                                <strong>Asia/Manila (Philippine Time - UTC+8)</strong>
                            </div>
                            <small class="form-text text-muted">Timezone is fixed to Philippine Time</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Default Currency</label>
                            <div class="currency-display">
                                <span class="currency-symbol">₱</span>
                                <input type="text" class="form-control" value="Philippine Peso (PHP)" disabled>
                            </div>
                            <small class="form-text text-muted">Default currency is fixed to PHP</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Date Format</label>
                            <select class="form-select" name="date_format">
                                <option value="MM/DD/YYYY" <?php echo getSetting('date_format') == 'MM/DD/YYYY' ? 'selected' : ''; ?>>MM/DD/YYYY</option>
                                <option value="DD/MM/YYYY" <?php echo getSetting('date_format') == 'DD/MM/YYYY' ? 'selected' : ''; ?>>DD/MM/YYYY</option>
                                <option value="YYYY-MM-DD" <?php echo getSetting('date_format') == 'YYYY-MM-DD' ? 'selected' : ''; ?>>YYYY-MM-DD</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal" onclick="prepareSettingsForm('general', 'General Settings')">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
            <?php endif; ?>

            <!-- 2. EMAIL & NOTIFICATIONS -->
            <?php if ($active_tab == 'email'): ?>
            <div class="settings-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-envelope"></i> Email & Notification Settings</h2>
                    <p>Configure email delivery and notification preferences</p>
                </div>

                <form method="POST" class="settings-form" id="emailForm">
                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-envelope-open"></i> SMTP Configuration</h5>
                        
                        <div class="form-group">
                            <label class="form-label">Sender Email Address</label>
                            <input type="email" class="form-control" name="sender_email" value="<?php echo htmlspecialchars(getSetting('sender_email', '')); ?>" placeholder="noreply@bookit.com">
                            <small class="form-text text-muted">Email address used for automated system emails</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">SMTP Host</label>
                            <input type="text" class="form-control" name="smtp_host" value="<?php echo htmlspecialchars(getSetting('smtp_host', '')); ?>" placeholder="smtp.gmail.com">
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">SMTP Port</label>
                                    <input type="number" class="form-control" name="smtp_port" value="<?php echo htmlspecialchars(getSetting('smtp_port', '587')); ?>" placeholder="587">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Encryption</label>
                                    <select class="form-select" name="smtp_encryption">
                                        <option value="tls" <?php echo getSetting('smtp_encryption', 'tls') == 'tls' ? 'selected' : ''; ?>>TLS</option>
                                        <option value="ssl" <?php echo getSetting('smtp_encryption', 'tls') == 'ssl' ? 'selected' : ''; ?>>SSL</option>
                                        <option value="none" <?php echo getSetting('smtp_encryption', 'tls') == 'none' ? 'selected' : ''; ?>>None</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">SMTP Username</label>
                            <input type="text" class="form-control" name="smtp_username" value="<?php echo htmlspecialchars(getSetting('smtp_username', '')); ?>" placeholder="your-email@gmail.com">
                        </div>

                        <div class="form-group">
                            <label class="form-label">SMTP Password</label>
                            <input type="password" class="form-control" name="smtp_password" value="<?php echo htmlspecialchars(getSetting('smtp_password', '')); ?>" placeholder="••••••••••">
                            <small class="form-text text-muted">For Gmail, use app-specific password</small>
                        </div>

                        <button type="button" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-paper-plane"></i> Test Email
                        </button>
                    </div>

                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-bell"></i> Notification Preferences</h5>
                        
                        <div class="notification-settings">
                            <div class="notification-item">
                                <div class="notification-check">
                                    <input type="checkbox" id="notif_reservation" name="notif_reservation" value="yes" <?php echo getSetting('notif_reservation') === 'yes' ? 'checked' : ''; ?>>
                                    <label for="notif_reservation">Reservation Confirmation Emails</label>
                                </div>
                                <p class="text-muted">Send email confirmations when reservations are made</p>
                            </div>

                            <div class="notification-item">
                                <div class="notification-check">
                                    <input type="checkbox" id="notif_payment" name="notif_payment" value="yes" <?php echo getSetting('notif_payment') === 'yes' ? 'checked' : ''; ?>>
                                    <label for="notif_payment">Payment Received Notifications</label>
                                </div>
                                <p class="text-muted">Notify hosts when payments are received</p>
                            </div>

                            <div class="notification-item">
                                <div class="notification-check">
                                    <input type="checkbox" id="notif_review" name="notif_review" value="yes" <?php echo getSetting('notif_review') === 'yes' ? 'checked' : ''; ?>>
                                    <label for="notif_review">Review & Rating Alerts</label>
                                </div>
                                <p class="text-muted">Alert hosts/renters about new reviews</p>
                            </div>

                            <div class="notification-item">
                                <div class="notification-check">
                                    <input type="checkbox" id="notif_system" name="notif_system" value="yes" <?php echo getSetting('notif_system') === 'yes' ? 'checked' : ''; ?>>
                                    <label for="notif_system">System Notifications</label>
                                </div>
                                <p class="text-muted">Important system alerts and updates</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-envelope"></i> Email Templates</h5>
                        <div class="template-buttons">
                            <button type="button" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-envelope"></i> Reservation Confirmation
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-money-bill"></i> Payment Receipt
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-key"></i> Password Reset
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-user-check"></i> Account Verification
                            </button>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal" onclick="prepareSettingsForm('email', 'Email Settings')">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
            <?php endif; ?>

            <!-- 3. PAYMENT CONFIGURATION -->
            <?php if ($active_tab == 'payment'): ?>
            <div class="settings-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-credit-card"></i> Payment Configuration</h2>
                    <p>Manage payment methods and transaction settings</p>
                </div>

                <form method="POST" class="settings-form" id="paymentForm">
                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-credit-card"></i> Available Payment Methods</h5>
                        
                        <div class="payment-methods">
                            <div class="payment-method-item">
                                <input type="checkbox" id="gcash" name="payment_gcash" value="yes" <?php echo getSetting('payment_gcash') === 'yes' ? 'checked' : ''; ?>>
                                <label for="gcash">
                                    <span class="method-icon"><i class="fas fa-mobile-alt"></i></span>
                                    GCash
                                </label>
                                <input type="text" class="form-control form-control-sm" name="gcash_account" value="<?php echo htmlspecialchars(getSetting('gcash_account', '')); ?>" placeholder="GCash Number/Account">
                            </div>

                            <div class="payment-method-item">
                                <input type="checkbox" id="bank" name="payment_bank" value="yes" <?php echo getSetting('payment_bank') === 'yes' ? 'checked' : ''; ?>>
                                <label for="bank">
                                    <span class="method-icon"><i class="fas fa-building"></i></span>
                                    Bank Transfer
                                </label>
                                <input type="text" class="form-control form-control-sm" name="bank_details" value="<?php echo htmlspecialchars(getSetting('bank_details', '')); ?>" placeholder="Bank Details">
                            </div>

                            <div class="payment-method-item">
                                <input type="checkbox" id="paypal" name="payment_paypal" value="yes" <?php echo getSetting('payment_paypal') === 'yes' ? 'checked' : ''; ?>>
                                <label for="paypal">
                                    <span class="method-icon"><i class="fab fa-cc-paypal"></i></span>
                                    PayPal
                                </label>
                                <input type="text" class="form-control form-control-sm" name="paypal_account" value="<?php echo htmlspecialchars(getSetting('paypal_account', '')); ?>" placeholder="PayPal Account">
                            </div>

                            <div class="payment-method-item">
                                <input type="checkbox" id="dragonpay" name="payment_dragonpay" value="yes" <?php echo getSetting('payment_dragonpay') === 'yes' ? 'checked' : ''; ?>>
                                <label for="dragonpay">
                                    <span class="method-icon"><i class="fas fa-dragon"></i></span>
                                    Dragonpay
                                </label>
                                <input type="text" class="form-control form-control-sm" name="dragonpay_id" value="<?php echo htmlspecialchars(getSetting('dragonpay_id', '')); ?>" placeholder="Dragonpay ID">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-cog"></i> Transaction Settings</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Default Currency</label>
                                    <div class="currency-display">
                                        <span class="currency-symbol">₱</span>
                                        <input type="text" class="form-control" value="Philippine Peso (PHP)" disabled>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Transaction Fee (%)</label>
                                    <input type="number" class="form-control" name="transaction_fee" value="<?php echo htmlspecialchars(getSetting('transaction_fee', '2.5')); ?>" step="0.01" placeholder="2.5">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Payment Instructions (for manual methods)</label>
                            <textarea class="form-control" name="payment_instructions" rows="5" placeholder="Add payment instructions here..."><?php echo htmlspecialchars(getSetting('payment_instructions', '')); ?></textarea>
                            <small class="form-text text-muted">Display these instructions to renters during payment</small>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal" onclick="prepareSettingsForm('payment', 'Payment Settings')">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
            <?php endif; ?>

            <!-- 4. SECURITY SETTINGS -->
            <?php if ($active_tab == 'security'): ?>
            <div class="settings-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-shield-alt"></i> Security & Privacy Settings</h2>
                    <p>Configure security policies and access controls</p>
                </div>

                <form method="POST" class="settings-form" id="securityForm">
                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-lock"></i> Login & Authentication</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Maximum Login Attempts</label>
                                    <input type="number" class="form-control" name="login_attempts" value="<?php echo htmlspecialchars(getSetting('login_attempts', '5')); ?>" placeholder="5">
                                    <small class="form-text text-muted">Failed attempts before lockout</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Lockout Duration (minutes)</label>
                                    <input type="number" class="form-control" name="lockout_duration" value="<?php echo htmlspecialchars(getSetting('lockout_duration', '30')); ?>" placeholder="30">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Session Timeout (minutes)</label>
                            <input type="number" class="form-control" name="session_timeout" value="<?php echo htmlspecialchars(getSetting('session_timeout', '60')); ?>" placeholder="60">
                            <small class="form-text text-muted">Auto logout after inactivity</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-key"></i> Password Policy</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Minimum Password Length</label>
                                    <input type="number" class="form-control" name="password_min_length" value="<?php echo htmlspecialchars(getSetting('password_min_length', '8')); ?>" placeholder="8">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Password Expiration (days)</label>
                                    <input type="number" class="form-control" name="password_expiration" value="<?php echo htmlspecialchars(getSetting('password_expiration', '90')); ?>" placeholder="90">
                                    <small class="form-text text-muted">0 = no expiration</small>
                                </div>
                            </div>
                        </div>

                        <div class="password-requirements">
                            <h6>Password Requirements</h6>
                            <div class="requirement-check">
                                <input type="checkbox" id="req_uppercase" name="req_uppercase" value="yes" <?php echo getSetting('req_uppercase') === 'yes' ? 'checked' : ''; ?>>
                                <label for="req_uppercase">Uppercase letters (A-Z)</label>
                            </div>
                            <div class="requirement-check">
                                <input type="checkbox" id="req_lowercase" name="req_lowercase" value="yes" <?php echo getSetting('req_lowercase') === 'yes' ? 'checked' : ''; ?>>
                                <label for="req_lowercase">Lowercase letters (a-z)</label>
                            </div>
                            <div class="requirement-check">
                                <input type="checkbox" id="req_numbers" name="req_numbers" value="yes" <?php echo getSetting('req_numbers') === 'yes' ? 'checked' : ''; ?>>
                                <label for="req_numbers">Numbers (0-9)</label>
                            </div>
                            <div class="requirement-check">
                                <input type="checkbox" id="req_special" name="req_special" value="yes" <?php echo getSetting('req_special') === 'yes' ? 'checked' : ''; ?>>
                                <label for="req_special">Special characters (!@#$%)</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-shield-alt"></i> Additional Security</h5>
                        
                        <div class="security-option">
                            <input type="checkbox" id="two_factor" name="two_factor" value="yes" <?php echo getSetting('two_factor') === 'yes' ? 'checked' : ''; ?>>
                            <label for="two_factor">Enable Two-Factor Authentication (2FA)</label>
                            <p class="text-muted">Require additional verification for admin login</p>
                        </div>

                        <div class="security-option">
                            <input type="checkbox" id="force_https" name="force_https" value="yes" <?php echo getSetting('force_https') === 'yes' ? 'checked' : ''; ?>>
                            <label for="force_https">Force HTTPS Connection</label>
                            <p class="text-muted">Redirect all traffic to secure connection</p>
                        </div>

                        <div class="security-option">
                            <input type="checkbox" id="ip_whitelist" name="ip_whitelist" value="yes" <?php echo getSetting('ip_whitelist') === 'yes' ? 'checked' : ''; ?>>
                            <label for="ip_whitelist">IP Whitelist for Admin Panel</label>
                            <p class="text-muted">Restrict admin access to specific IP addresses</p>
                        </div>
                    </div>

                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-history"></i> Activity Logs</h5>
                        
                        <div class="activity-log-info">
                            <p>View and manage system activity logs for audit purposes</p>
                            <button type="button" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-eye"></i> View Activity Logs
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-download"></i> Export Logs
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-trash"></i> Clear Old Logs
                            </button>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal" onclick="prepareSettingsForm('security', 'Security Settings')">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
            <?php endif; ?>

            <!-- 5. ACCESS CONTROL -->
            <?php if ($active_tab == 'access'): ?>
            <div class="settings-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-users-cog"></i> User Access Control</h2>
                    <p>Manage roles, permissions, and admin accounts</p>
                </div>

                <div class="access-control-container">
                    <div class="access-section">
                        <h5 class="section-title"><i class="fas fa-user-tie"></i> Admin Accounts</h5>
                        
                        <div class="admin-list">
                            <?php 
                            if (is_array($admins) && count($admins) > 0) {
                                foreach ($admins as $admin):
                            ?>
                            <div class="admin-item">
                                <div class="admin-info">
                                    <div class="admin-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="admin-details">
                                        <h6><?php echo htmlspecialchars($admin['full_name']); ?></h6>
                                        <p class="text-muted"><?php echo htmlspecialchars($admin['email']); ?></p>
                                    </div>
                                </div>
                                <div class="admin-actions">
                                    <button class="btn btn-sm btn-outline-primary">Edit</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="disableAdminAccount(<?php echo $admin['user_id']; ?>)">
                                        <?php echo $admin['is_active'] ? 'Disable' : 'Enable'; ?>
                                    </button>
                                </div>
                            </div>
                            <?php 
                                endforeach;
                            } else {
                                echo '<p class="text-muted">No admin accounts found</p>';
                            }
                            ?>
                        </div>

                        <button type="button" class="btn btn-primary btn-sm mt-3">
                            <i class="fas fa-user-plus"></i> Add Admin Account
                        </button>
                    </div>

                    <div class="access-section">
                        <h5 class="section-title"><i class="fas fa-lock"></i> Roles & Permissions</h5>
                        
                        <div class="roles-grid">
                            <div class="role-card">
                                <h6><i class="fas fa-crown"></i> Admin</h6>
                                <div class="permissions-list">
                                    <span class="badge bg-success">Create</span>
                                    <span class="badge bg-success">Read</span>
                                    <span class="badge bg-success">Update</span>
                                    <span class="badge bg-success">Delete</span>
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2">Edit Permissions</button>
                            </div>

                            <div class="role-card">
                                <h6><i class="fas fa-user-tie"></i> Manager/Host</h6>
                                <div class="permissions-list">
                                    <span class="badge bg-success">Create</span>
                                    <span class="badge bg-success">Read</span>
                                    <span class="badge bg-success">Update</span>
                                    <span class="badge bg-warning">Delete (Own)</span>
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2">Edit Permissions</button>
                            </div>

                            <div class="role-card">
                                <h6><i class="fas fa-user"></i> Renter</h6>
                                <div class="permissions-list">
                                    <span class="badge bg-success">Read</span>
                                    <span class="badge bg-success">Create (Book)</span>
                                    <span class="badge bg-warning">Update (Own)</span>
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2">Edit Permissions</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php endif; ?>

            <!-- 6. DATA MANAGEMENT -->
            <?php if ($active_tab == 'data'): ?>
            <div class="settings-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-database"></i> System Data Management</h2>
                    <p>Backup, restore, and manage system data</p>
                </div>

                <div class="data-management-container">
                    <div class="data-section">
                        <h5 class="section-title"><i class="fas fa-shield-alt"></i> Database Backup & Restore</h5>
                        
                        <div class="backup-info-box">
                            <div class="backup-info">
                                <p><strong>Last Backup:</strong> November 13, 2025 at 3:45 PM</p>
                                <p><strong>Backup Size:</strong> 125 MB</p>
                            </div>
                        </div>

                        <div class="backup-actions">
                            <button type="button" class="btn btn-primary">
                                <i class="fas fa-save"></i> Create Backup Now
                            </button>
                            <button type="button" class="btn btn-outline-primary">
                                <i class="fas fa-history"></i> Backup History
                            </button>
                            <button type="button" class="btn btn-outline-warning">
                                <i class="fas fa-undo"></i> Restore From Backup
                            </button>
                        </div>
                    </div>

                    <div class="data-section">
                        <h5 class="section-title"><i class="fas fa-file-export"></i> Data Export</h5>
                        
                        <div class="export-options">
                            <div class="export-item">
                                <h6>Export All Data</h6>
                                <p class="text-muted">Download complete database in various formats</p>
                                <div class="export-buttons">
                                    <button type="button" class="btn btn-sm btn-outline-primary">CSV</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary">Excel</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary">PDF</button>
                                </div>
                            </div>

                            <div class="export-item">
                                <h6>Export By Category</h6>
                                <select class="form-select form-select-sm">
                                    <option>Select data type...</option>
                                    <option>Users</option>
                                    <option>Reservations</option>
                                    <option>Payments</option>
                                    <option>Units</option>
                                    <option>Branches</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="data-section">
                        <h5 class="section-title"><i class="fas fa-folder"></i> Storage Management</h5>
                        
                        <div class="storage-stats">
                            <div class="storage-item">
                                <span class="storage-label">Profile Pictures</span>
                                <span class="storage-size">45 MB</span>
                            </div>
                            <div class="storage-item">
                                <span class="storage-label">Unit Images</span>
                                <span class="storage-size">320 MB</span>
                            </div>
                            <div class="storage-item">
                                <span class="storage-label">Documents</span>
                                <span class="storage-size">85 MB</span>
                            </div>
                            <div class="storage-item">
                                <span class="storage-label">System Logs</span>
                                <span class="storage-size">12 MB</span>
                            </div>
                        </div>

                        <button type="button" class="btn btn-outline-danger btn-sm mt-3">
                            <i class="fas fa-broom"></i> Clear Cache
                        </button>
                    </div>

                    <div class="data-section danger-zone">
                        <h5 class="section-title text-danger"><i class="fas fa-exclamation-triangle"></i> System Logs</h5>
                        
                        <button type="button" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-eye"></i> View System Logs
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-trash"></i> Clear All Logs
                        </button>
                        <small class="d-block mt-2 text-muted">Clearing logs cannot be undone</small>
                    </div>
                </div>
            </div>
            <?php endif; ?>

            <!-- 7. DEFAULTS -->
            <?php if ($active_tab == 'defaults'): ?>
            <div class="settings-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-building"></i> Branches & Amenity Defaults</h2>
                    <p>Manage default settings for branches and amenities</p>
                </div>

                <div class="defaults-container">
                    <div class="defaults-section">
                        <h5 class="section-title"><i class="fas fa-building"></i> Branch Settings</h5>
                        
                        <div class="branch-list">
                            <?php 
                            if (is_array($all_branches) && count($all_branches) > 0) {
                                foreach ($all_branches as $branch):
                            ?>
                            <div class="branch-item">
                                <div class="branch-info">
                                    <h6><?php echo htmlspecialchars($branch['branch_name']); ?></h6>
                                    <p class="text-muted">Units: <?php echo $branch['unit_count']; ?></p>
                                </div>
                                <div class="branch-actions">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editBranch(<?php echo $branch['branch_id']; ?>)">Edit</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteBranch(<?php echo $branch['branch_id']; ?>, '<?php echo htmlspecialchars($branch['branch_name']); ?>')">Delete</button>
                                </div>
                            </div>
                            <?php 
                                endforeach;
                            } else {
                                echo '<p class="text-muted">No branches found</p>';
                            }
                            ?>
                        </div>

                        <button type="button" class="btn btn-primary btn-sm mt-3" onclick="addBranch()">
                            <i class="fas fa-plus"></i> Add Branch
                        </button>
                    </div>

                    <div class="defaults-section">
                        <h5 class="section-title"><i class="fas fa-star"></i> Default Amenities</h5>
                        
                        <div class="amenities-list">
                            <?php 
                            if (is_array($all_amenities) && count($all_amenities) > 0) {
                                foreach ($all_amenities as $amenity):
                            ?>
                            <div class="amenity-item">
                                <div class="amenity-checkbox">
                                    <input type="checkbox" id="amenity_<?php echo $amenity['amenity_id'] ?? sanitize_input(str_replace(' ', '_', strtolower($amenity['amenity_name']))); ?>" checked>
                                    <label for="amenity_<?php echo $amenity['amenity_id'] ?? sanitize_input(str_replace(' ', '_', strtolower($amenity['amenity_name']))); ?>">
                                        <?php echo htmlspecialchars($amenity['amenity_name']); ?>
                                    </label>
                                </div>
                                <input type="number" class="amenity-price" placeholder="Price" value="<?php echo $amenity['hourly_rate'] ?? 0; ?>" step="0.01">
                            </div>
                            <?php 
                                endforeach;
                            } else {
                                echo '<p class="text-muted">No amenities found in database</p>';
                            }
                            ?>
                        </div>

                        <button type="button" class="btn btn-outline-primary btn-sm mt-3" onclick="addCustomAmenity()">
                            <i class="fas fa-plus"></i> Add Custom Amenity
                        </button>
                    </div>
                </div>
            </div>
            <?php endif; ?>

            <!-- 8. UI CUSTOMIZATION -->
            <?php if ($active_tab == 'ui'): ?>
            <div class="settings-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-palette"></i> UI Customization</h2>
                    <p>Customize the appearance and branding of the system</p>
                </div>

                <form method="POST" class="settings-form" id="uiForm">
                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-paint-brush"></i> Theme Colors</h5>
                        
                        <div class="color-settings">
                            <div class="color-item">
                                <label class="form-label">Primary Color</label>
                                <div class="color-picker-group">
                                    <input type="color" class="color-picker" value="#3498db">
                                    <input type="text" class="form-control form-control-sm" value="#3498db">
                                </div>
                            </div>

                            <div class="color-item">
                                <label class="form-label">Secondary Color</label>
                                <div class="color-picker-group">
                                    <input type="color" class="color-picker" value="#2c3e50">
                                    <input type="text" class="form-control form-control-sm" value="#2c3e50">
                                </div>
                            </div>

                            <div class="color-item">
                                <label class="form-label">Success Color</label>
                                <div class="color-picker-group">
                                    <input type="color" class="color-picker" value="#27ae60">
                                    <input type="text" class="form-control form-control-sm" value="#27ae60">
                                </div>
                            </div>

                            <div class="color-item">
                                <label class="form-label">Danger Color</label>
                                <div class="color-picker-group">
                                    <input type="color" class="color-picker" value="#e74c3c">
                                    <input type="text" class="form-control form-control-sm" value="#e74c3c">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-image"></i> Branding</h5>
                        
                        <div class="form-group">
                            <label class="form-label">Homepage Banner</label>
                            <div class="banner-upload">
                                <div class="banner-preview">
                                    <img src="../assets/images/banner.jpg" alt="Banner" id="bannerPreview">
                                </div>
                                <input type="file" class="form-control" id="bannerFile" accept="image/*">
                                <small class="form-text text-muted">Recommended size: 1200x400px</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Background Image</label>
                            <input type="file" class="form-control" accept="image/*">
                            <small class="form-text text-muted">Will be used as page background</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-heading"></i> Custom Messages</h5>
                        
                        <div class="form-group">
                            <label class="form-label">Homepage Welcome Title</label>
                            <input type="text" class="form-control" placeholder="Welcome to BookIT Rentals">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Homepage Welcome Description</label>
                            <textarea class="form-control" rows="4" placeholder="Add welcome message..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Footer Copyright Text</label>
                            <input type="text" class="form-control" placeholder="© 2025 BookIT. All rights reserved.">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal" onclick="prepareSettingsForm('ui', 'UI Settings')">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button type="reset" class="btn btn-outline-secondary">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                </form>
            </div>
            <?php endif; ?>

        </div>

    </main>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmTitle">Save Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure you want to save these settings? This will update the system for all users.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmBtn">
                    <i class="fas fa-check"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentForm = null;
let currentFormType = null;

function prepareSettingsForm(formType, formTitle) {
    currentFormType = formType;
    currentForm = document.querySelector(`#${formType}Form`) || document.querySelector('form.settings-form');
    
    document.getElementById('confirmTitle').textContent = `Save ${formTitle}`;
    document.getElementById('confirmMessage').textContent = `Are you sure you want to save these ${formTitle.toLowerCase()}? This will update the system for all users.`;
}

document.getElementById('confirmBtn').addEventListener('click', async function() {
    if (!currentForm) {
        alert('Error: Form not found');
        return;
    }

    const formData = new FormData(currentForm);
    
    // Add the appropriate save flag
    if (currentFormType === 'general') {
        formData.append('save_general', '1');
    } else if (currentFormType === 'email') {
        formData.append('save_email', '1');
    } else if (currentFormType === 'payment') {
        formData.append('save_payment', '1');
    } else if (currentFormType === 'security') {
        formData.append('save_security', '1');
    } else if (currentFormType === 'branch_defaults') {
        formData.append('save_branch_defaults', '1');
    } else if (currentFormType === 'ui') {
        formData.append('save_ui', '1');
    }

    try {
        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            // Show success message
            showAlert(result.message, 'success');
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            // Reload page after 1.5 seconds
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('An error occurred while saving settings', 'danger');
    }
});

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    // Auto remove alert after 5 seconds
    setTimeout(() => {
        const alert = document.querySelector('[role="alert"]');
        if (alert) alert.remove();
    }, 5000);
}
</script>
<script src="../assets/js/admin/settings.js"></script>

</body>
</html>

C:\wamp64\www\BookIT\admin\unit_management.php
    <?php
    // BookIT Unit Management
    // Multi-branch Condo Rental Reservation System

    include '../includes/session.php';
    include '../includes/functions.php';
    include_once '../config/db.php';
    checkRole(['admin']); // Only admin can access

    $message = '';
    $error = '';

    // Handle form submissions
    if ($_SERVER['REQUEST_METHOD'] == 'POST') {
        if (isset($_POST['add_unit'])) {
            // Add new unit - USING YOUR EXISTING COLUMNS
            $unit_number = sanitize_input($_POST['unit_number']);
            $unit_type = sanitize_input($_POST['unit_type']);
            $branch_id = (int)$_POST['branch_id'];
            $price = (float)$_POST['price'];
            $floor_number = !empty($_POST['floor_number']) ? (int)$_POST['floor_number'] : null;
            $max_occupancy = (int)$_POST['max_occupancy'];
            $security_deposit = (float)$_POST['security_deposit'];
            $description = sanitize_input($_POST['description']);
            
            // Use your existing columns
            $sql = "INSERT INTO units (unit_number, unit_type, branch_id, price, floor_number, max_occupancy, security_deposit, description) 
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)";
            
            if (execute_query($sql, [$unit_number, $unit_type, $branch_id, $price, $floor_number, $max_occupancy, $security_deposit, $description])) {
                $message = "Unit added successfully!";
            } else {
                $error = "Failed to add unit!";
            }
        }
        
        if (isset($_POST['update_unit'])) {
            // Update existing unit - USING YOUR EXISTING COLUMNS
            $unit_id = (int)$_POST['unit_id'];
            $unit_number = sanitize_input($_POST['unit_number']);
            $unit_type = sanitize_input($_POST['unit_type']);
            $branch_id = (int)$_POST['branch_id'];
            $price = (float)$_POST['price'];
            $floor_number = !empty($_POST['floor_number']) ? (int)$_POST['floor_number'] : null;
            $max_occupancy = (int)$_POST['max_occupancy'];
            $security_deposit = (float)$_POST['security_deposit'];
            $description = sanitize_input($_POST['description']);
            
            $sql = "UPDATE units SET unit_number = ?, unit_type = ?, branch_id = ?, 
                    price = ?, floor_number = ?, max_occupancy = ?, security_deposit = ?, description = ? 
                    WHERE unit_id = ?";
            
            if (execute_query($sql, [$unit_number, $unit_type, $branch_id, $price, $floor_number, $max_occupancy, $security_deposit, $description, $unit_id])) {
                $message = "Unit updated successfully!";
            } else {
                $error = "Failed to update unit!";
            }
        }
        
        if (isset($_POST['delete_unit'])) {
            // Delete unit (soft delete) - USING YOUR EXISTING is_available COLUMN
            $unit_id = (int)$_POST['unit_id'];
            $sql = "UPDATE units SET is_available = 0 WHERE unit_id = ?";
            if (execute_query($sql, [$unit_id])) {
                $message = "Unit deleted successfully!";
            } else {
                $error = "Failed to delete unit!";
            }
        }
        
        if (isset($_POST['change_status'])) {
            // Change unit status - USING YOUR EXISTING is_available COLUMN
            $unit_id = (int)$_POST['unit_id'];
            $status = sanitize_input($_POST['status']);
            
            // Convert status to is_available (1 for available, 0 for occupied/maintenance)
            $is_available = ($status === 'available') ? 1 : 0;
            
            $sql = "UPDATE units SET is_available = ? WHERE unit_id = ?";
            if (execute_query($sql, [$is_available, $unit_id])) {
                $message = "Unit status updated successfully!";
            } else {
                $error = "Failed to update unit status!";
            }
        }
    }

    // PHP function to get unit details
    function getUnitDetails($unit_id) {
        global $conn;
        
        $unit = get_single_result("
            SELECT u.*, b.branch_name, b.location 
            FROM units u 
            LEFT JOIN branches b ON u.branch_id = b.branch_id 
            WHERE u.unit_id = ?
        ", [$unit_id]);

        if (!$unit) return null;

        // Fetch performance metrics
        $metrics = get_single_result("
            SELECT 
                COUNT(*) as total_bookings,
                COUNT(CASE WHEN status IN ('confirmed', 'checked_in') THEN 1 END) as active_bookings,
                COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed_bookings,
                SUM(total_amount) as total_revenue,
                AVG(rating) as avg_rating
            FROM reservations 
            WHERE unit_id = ?
        ", [$unit_id]);

        // Fetch recent bookings
        $recent_bookings = get_multiple_results("
            SELECT r.reservation_id, r.check_in_date, r.check_out_date, r.status, r.total_amount, u.user_name
            FROM reservations r 
            LEFT JOIN users u ON r.user_id = u.user_id 
            WHERE r.unit_id = ? 
            ORDER BY r.created_at DESC 
            LIMIT 5
        ", [$unit_id]);

        return [
            'unit' => $unit,
            'metrics' => $metrics,
            'recent_bookings' => $recent_bookings
        ];
    }

    // ==================== FETCH UNITS WITH PERFORMANCE METRICS ====================
    $units = [];
    try {
        // Search and filter parameters
        $q = isset($_GET['q']) ? trim($_GET['q']) : '';
        $branch_filter = isset($_GET['branch']) ? $_GET['branch'] : 'all';
        $type_filter = isset($_GET['type']) ? $_GET['type'] : 'all';
        $status_filter = isset($_GET['status']) ? $_GET['status'] : 'all';
        
        // IMPORTANT: Only show units from ACTIVE branches
        $where = "WHERE u.is_available = 1 AND b.is_active = 1";
        $params = [];
        
        if ($q !== '') {
            $where .= " AND (u.unit_number LIKE ? OR u.description LIKE ?)";
            $search_term = "%$q%";
            array_push($params, $search_term, $search_term);
        }
        
        if ($branch_filter !== 'all') {
            $where .= " AND u.branch_id = ?";
            $params[] = $branch_filter;
        }
        
        if ($type_filter !== 'all') {
            $where .= " AND u.unit_type = ?";
            $params[] = $type_filter;
        }

        // UPDATED SQL QUERY - Only include revenue from ACTIVE branches
        $sql = "SELECT 
                    u.*, 
                    b.branch_name,
                    b.is_active as branch_active,  // Add this to check branch status
                    (SELECT COUNT(*) FROM reservations r WHERE r.unit_id = u.unit_id AND r.branch_id = b.branch_id) as total_bookings,
                    (SELECT COUNT(*) FROM reservations r WHERE r.unit_id = u.unit_id AND r.status IN ('confirmed', 'checked_in') AND r.branch_id = b.branch_id) as active_bookings,
                    (SELECT COUNT(*) FROM reservations r WHERE r.unit_id = u.unit_id AND r.status = 'completed' AND r.branch_id = b.branch_id) as completed_bookings,
                    (SELECT SUM(r.total_amount) FROM reservations r WHERE r.unit_id = u.unit_id AND r.status IN ('confirmed', 'checked_in', 'completed') AND r.branch_id = b.branch_id) as total_revenue,
                    (SELECT AVG(rv.rating) FROM reviews rv WHERE rv.unit_id = u.unit_id) as avg_rating
                FROM units u
                LEFT JOIN branches b ON u.branch_id = b.branch_id
                $where
                ORDER BY u.created_at DESC";

        // Rest of your existing code...
        
    } catch (Exception $e) {
        $error = "Database error: " . $e->getMessage();
        error_log($error);
    }

    // Get available data for filters - ONLY ACTIVE BRANCHES
    $branches = get_multiple_results("SELECT branch_id, branch_name FROM branches WHERE is_active = 1");
    $unit_types = get_multiple_results("SELECT DISTINCT unit_type FROM units WHERE unit_type IS NOT NULL");

    // Calculate overall statistics - UPDATED to exclude inactive branches
    $total_units = count($units);
    $available_units = count(array_filter($units, fn($u) => $u['is_available'] == 1 && $u['branch_active'] == 1));
    $occupied_units = count(array_filter($units, fn($u) => $u['is_available'] == 0 && $u['branch_active'] == 1));
    $maintenance_units = 0;
    $total_revenue = array_sum(array_column($units, 'total_revenue'));
    $avg_occupancy = $total_units > 0 ? round(array_sum(array_column($units, 'occupancy_rate')) / $total_units, 1) : 0;

    // Get unit details for modal if view_unit parameter is set
    $view_unit_data = null;
    if (isset($_GET['view_unit'])) {
        $view_unit_data = getUnitDetails((int)$_GET['view_unit']);
    }
    ?>
    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit Management - BookIT Admin</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css"> 
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/admin/unit_management.css">
    </head>
    <body>

    <!-- =================== BUILT-IN SIDEBAR =================== -->
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <i class="fas fa-building"></i>
            <span>BookIT Admin</span>
        </div>
        <nav class="sidebar-menu">
            <ul>
                <li><a href="<?php echo SITE_URL; ?>/admin/admin_dashboard.php"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/admin/manage_branch.php"><i class="fas fa-code-branch"></i><span>Branch Management</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/admin/user_management.php"><i class="fas fa-users"></i> <span>User Management</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/admin/unit_management.php" class="active"><i class="fas fa-home"></i> <span>Unit Management</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/modules/reservations.php"><i class="fas fa-calendar-check"></i> <span>Reservation Management</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/modules/payment_management.php"><i class="fas fa-credit-card"></i> <span>Payment Management</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/admin/amenity_management.php"><i class="fas fa-swimming-pool"></i> <span>Amenity Management</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/admin/reports.php"><i class="fas fa-chart-line"></i> <span>Reports</span></a></li>
                <li><a href="<?php echo SITE_URL; ?>/admin/settings.php"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
            </ul>
        </nav>

        <!-- =================== PROFILE SECTION =================== -->
        <div class="sidebar-profile">
            <div class="profile-info">
                <div class="profile-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="profile-details">
                    <span class="profile-name"><?php echo htmlspecialchars($_SESSION['fullname'] ?? 'Admin'); ?></span>
                    <span class="profile-role"><?php echo htmlspecialchars(ucfirst($_SESSION['role'] ?? 'Admin')); ?></span>
                </div>
            </div>
            <a href="<?php echo SITE_URL; ?>/public/logout.php" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
            </a>
        </div>
    </aside>

    <main class="content">
        <div class="page-header">
            <div class="page-title">
                <h1>Unit Management</h1>
                <p>Manage all units across branches and their performance</p>
            </div>
            <div class="page-actions">
                <button type="button" class="btn-refresh" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button type="button" class="btn-export" onclick="exportUnits('pdf')">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <button type="button" class="btn-export" onclick="exportUnits('csv')">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button type="button" class="btn-add" data-bs-toggle="modal" data-bs-target="#addUnitModal">
                    <i class="fas fa-plus"></i> Add Unit
                </button>
            </div>
        </div>

        <!-- Messages -->
        <?php if ($message): ?>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i> <?php echo $message; ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <?php endif; ?>

        <?php if ($error): ?>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle"></i> <?php echo $error; ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <?php endif; ?>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card">
                <div class="card-icon"><i class="fas fa-home"></i></div>
                <div class="card-info">
                    <h3><?= $total_units ?></h3>
                    <p>Total Units</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-check-circle"></i></div>
                <div class="card-info">
                    <h3><?= $available_units ?></h3>
                    <p>Available</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-user-friends"></i></div>
                <div class="card-info">
                    <h3><?= $occupied_units ?></h3>
                    <p>Occupied</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-tools"></i></div>
                <div class="card-info">
                    <h3><?= $maintenance_units ?></h3>
                    <p>Maintenance</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                <div class="card-info">
                    <h3><?= $avg_occupancy ?>%</h3>
                    <p>Avg Occupancy</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-money-bill-wave"></i></div>
                <div class="card-info">
                    <h3>₱<?= number_format($total_revenue, 2) ?></h3>
                    <p>Total Revenue</p>
                </div>
            </div>
        </div>

        <!-- Search & Filter Section -->
        <div class="filter-section">
            <form method="GET" class="search-form">
                <div class="search-group">
                    <input type="text" name="q" placeholder="Search units by number or description" 
                        value="<?= isset($_GET['q']) ? htmlspecialchars($_GET['q']) : '' ?>"
                        class="form-control">
                </div>
                
                <div class="filter-group">
                    <select name="branch" class="form-select">
                        <option value="all">All Branches</option>
                        <?php foreach ($branches as $branch): ?>
                            <option value="<?= $branch['branch_id'] ?>" 
                                <?= (isset($_GET['branch']) && $_GET['branch'] == $branch['branch_id']) ? 'selected' : '' ?>>
                                <?= htmlspecialchars($branch['branch_name']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="filter-group">
                    <select name="type" class="form-select">
                        <option value="all">All Types</option>
                        <?php foreach ($unit_types as $type): ?>
                            <option value="<?= $type['unit_type'] ?>" 
                                <?= (isset($_GET['type']) && $_GET['type'] == $type['unit_type']) ? 'selected' : '' ?>>
                                <?= htmlspecialchars($type['unit_type']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="filter-group">
                    <select name="status" class="form-select">
                        <option value="all">All Status</option>
                        <option value="available" <?= (isset($_GET['status']) && $_GET['status'] === 'available') ? 'selected' : '' ?>>Available</option>
                        <option value="occupied" <?= (isset($_GET['status']) && $_GET['status'] === 'occupied') ? 'selected' : '' ?>>Occupied</option>
                    </select>
                </div>

                <button type="submit" class="btn-search">
                    <i class="fas fa-search"></i> Search
                </button>
                <a href="unit_management.php" class="btn-clear">Clear Filters</a>
            </form>
        </div>

        <!-- Units Table -->
        <div class="table-card">
            <div class="table-header">
                <div class="table-title">Unit Details & Performance</div>
                <div class="table-info">
                    Showing <?= count($units) ?> unit(s)
                </div>
            </div>
            <table id="unitsTable" class="display table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Unit Details</th>
                        <th>Branch</th>
                        <th>Price</th>
                        <th>Performance</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($units as $unit): ?>
                    <tr>
                        <td>#U<?= str_pad($unit['unit_id'], 4, '0', STR_PAD_LEFT) ?></td>
                        <td>
                            <strong><?= htmlspecialchars($unit['unit_number']) ?></strong><br>
                            <small class="text-muted"><?= htmlspecialchars($unit['unit_type']) ?></small><br>
                            <small>Floor: <?= $unit['floor_number'] ?? 'N/A' ?> • Capacity: <?= $unit['max_occupancy'] ?> persons</small>
                        </td>
                        <td>
                            <span class="badge branch-badge"><?= htmlspecialchars($unit['branch_name']) ?></span>
                        </td>
                        <td>
                            <strong>₱<?= number_format($unit['price'], 2) ?></strong><br>
                            <small class="text-muted">per night</small>
                        </td>
                        <td>
                            <div class="performance-metrics">
                                <div class="metric-row">
                                    <span class="metric-label">Bookings:</span>
                                    <span class="metric-value"><?= $unit['total_bookings'] ?></span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Occupancy:</span>
                                    <span class="metric-value"><?= $unit['occupancy_rate'] ?>%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Revenue:</span>
                                    <strong>₱<?= number_format($unit['total_revenue'] ?? 0, 2) ?></strong>
                                </div>
                                <?php if ($unit['avg_rating']): ?>
                                <div class="metric-row">
                                    <span class="metric-label">Rating:</span>
                                    <span class="metric-value">
                                        <i class="fas fa-star text-warning"></i> <?= number_format($unit['avg_rating'], 1) ?>
                                    </span>
                                </div>
                                <?php endif; ?>
                            </div>
                        </td>
                        <td>
                            <span class="badge status-<?= $unit['status'] ?>">
                                <?= ucfirst($unit['status']) ?>
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button type="button" class="btn-view" 
                                        onclick="viewUnit(<?= $unit['unit_id'] ?>)" 
                                        title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn-edit" 
                                        onclick="editUnit(<?= $unit['unit_id'] ?>)" 
                                        title="Edit Unit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn-status" 
                                        onclick="changeStatus(<?= $unit['unit_id'] ?>, '<?= $unit['unit_number'] ?>')" 
                                        title="Change Status">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button type="button" class="btn-delete" 
                                        onclick="confirmDelete(<?= $unit['unit_id'] ?>, '<?= htmlspecialchars($unit['unit_number']) ?>')" 
                                        title="Delete Unit">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </main>

    <!-- ==================== MODALS SECTION ==================== -->
    <!-- Add Unit Modal -->
    <div class="modal fade" id="addUnitModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Unit</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Unit Number *</label>
                                    <input type="text" class="form-control" name="unit_number" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Unit Type *</label>
                                    <select class="form-select" name="unit_type" required>
                                        <option value="">Select Type</option>
                                        <option value="Studio">Studio</option>
                                        <option value="1 Bedroom">1 Bedroom</option>
                                        <option value="2 Bedrooms">2 Bedrooms</option>
                                        <option value="3 Bedrooms">3 Bedrooms</option>
                                        <option value="Penthouse">Penthouse</option>
                                        <option value="Executive Suite">Executive Suite</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Branch *</label>
                                    <select class="form-select" name="branch_id" required>
                                        <option value="">Select Branch</option>
                                        <?php foreach ($branches as $branch): ?>
                                            <option value="<?= $branch['branch_id'] ?>">
                                                <?= htmlspecialchars($branch['branch_name']) ?>
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Price per Night (₱) *</label>
                                    <input type="number" class="form-control" name="price" step="0.01" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Floor Number</label>
                                    <input type="number" class="form-control" name="floor_number" min="1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Max Occupancy *</label>
                                    <input type="number" class="form-control" name="max_occupancy" min="1" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Security Deposit</label>
                                    <input type="number" class="form-control" name="security_deposit" step="0.01" min="0" value="0.00">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3" placeholder="Describe the unit features and location..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="add_unit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Add Unit
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Unit Modal -->
    <div class="modal fade" id="viewUnitModal" tabindex="-1" aria-labelledby="viewUnitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="viewUnitModalLabel">
                        <i class="fas fa-eye me-2"></i>Unit Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewUnitModalBody">
                    <!-- Content will be populated by PHP/JavaScript -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Select a unit to view details...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Close
                    </button>
                    <button type="button" class="btn btn-warning" onclick="editSelectedUnit()">
                        <i class="fas fa-edit me-2"></i>Edit Unit
                    </button>
                    <button type="button" class="btn btn-primary" onclick="createBookingForUnit()">
                        <i class="fas fa-calendar-plus me-2"></i>Create Booking
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Unit Modal -->
    <div class="modal fade" id="editUnitModal" tabindex="-1" aria-labelledby="editUnitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title" id="editUnitModalLabel">
                        <i class="fas fa-edit me-2"></i>Edit Unit
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="editUnitModalBody">
                    <!-- Content will be populated by AJAX -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading unit details...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Status Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST">
                    <input type="hidden" name="unit_id" id="status_unit_id">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-sync-alt"></i> Change Unit Status</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Change status for unit: <strong id="status_unit_name"></strong></p>
                        <div class="mb-3">
                            <label class="form-label">New Status</label>
                            <select class="form-select" name="status" required>
                                <option value="available">Available</option>
                                <option value="occupied">Occupied</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="change_status" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update Status
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST">
                    <input type="hidden" name="unit_id" id="delete_unit_id">
                    <div class="modal-header">
                        <h5 class="modal-title text-danger"><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this unit?</p>
                        <p><strong>Unit:</strong> <span id="delete_unit_name"></span></p>
                        <p class="text-muted">This action will remove the unit from the system. Existing reservations will be preserved.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="delete_unit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Delete Unit
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Required Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

    <script src="../assets/js/admin/unit_management.js"></script>

    <script>
    // PHP to JavaScript data passing for View Modal
    const viewUnitData = <?= isset($view_unit_data) ? json_encode($view_unit_data) : 'null' ?>;
    const currentViewUnitId = <?= isset($_GET['view_unit']) ? (int)$_GET['view_unit'] : 'null' ?>;
    </script>
    </body>
    </html>

C:\wamp64\www\BookIT\admin\update_admin.php
<?php
// BookIT Admin Password Update
// Run this script to update admin password

include_once '../config/db.php';

// New admin credentials
$admin_email = 'admin@bookit.com';
$new_password = 'admin123'; // Change this to your desired password
$hashed_password = password_hash($new_password, PASSWORD_DEFAULT);

// Update admin password
$sql = "UPDATE users SET password = ? WHERE email = ? AND role = 'admin'";
$stmt = $conn->prepare($sql);
$stmt->bind_param("ss", $hashed_password, $admin_email);

if ($stmt->execute()) {
    echo "Admin password updated successfully!<br>";
    echo "Email: " . $admin_email . "<br>";
    echo "Password: " . $new_password . "<br>";
    echo "<a href='../public/login.php'>Go to Login</a>";
} else {
    echo "Failed to update admin password.";
}

$stmt->close();
$conn->close();
?>

C:\wamp64\www\BookIT\admin\update_unit.php
<?php
// update_unit.php
include '../includes/session.php';
include '../includes/functions.php';
include_once '../config/db.php';
checkRole(['admin']);

header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['update_unit'])) {
    $unit_id = (int)$_POST['unit_id'];
    $unit_number = sanitize_input($_POST['unit_number']);
    $unit_type = sanitize_input($_POST['unit_type']);
    $branch_id = (int)$_POST['branch_id'];
    $price = (float)$_POST['price'];
    $floor_number = !empty($_POST['floor_number']) ? (int)$_POST['floor_number'] : null;
    $max_occupancy = (int)$_POST['max_occupancy'];
    $security_deposit = (float)$_POST['security_deposit'];
    $description = sanitize_input($_POST['description']);
    
    // Check if unit number already exists in the same branch (excluding current unit)
    $check_sql = "SELECT unit_id FROM units WHERE unit_number = ? AND branch_id = ? AND unit_id != ?";
    $check_result = get_single_result($check_sql, [$unit_number, $branch_id, $unit_id]);
    
    if ($check_result) {
        echo json_encode([
            'success' => false,
            'message' => 'Unit number already exists in this branch!',
            'unit_id' => $unit_id
        ]);
        exit;
    }
    
    // Validate inputs
    if ($price <= 0) {
        echo json_encode([
            'success' => false,
            'message' => 'Price must be greater than 0!',
            'unit_id' => $unit_id
        ]);
        exit;
    }
    
    if ($max_occupancy <= 0) {
        echo json_encode([
            'success' => false,
            'message' => 'Max occupancy must be at least 1!',
            'unit_id' => $unit_id
        ]);
        exit;
    }
    
    if (empty($_POST['unit_number']) || empty($_POST['unit_type'])) {
        $_SESSION['error'] = "Fill all required fields.";
        header('Location: ' . $_SERVER['HTTP_REFERER']);
        exit;
    }
    
    $sql = "UPDATE units SET 
            unit_number = ?, 
            unit_type = ?, 
            branch_id = ?, 
            price = ?, 
            floor_number = ?, 
            max_occupancy = ?, 
            security_deposit = ?, 
            description = ?,
            updated_at = NOW()
            WHERE unit_id = ?";
    
    if (execute_query($sql, [$unit_number, $unit_type, $branch_id, $price, $floor_number, $max_occupancy, $security_deposit, $description, $unit_id])) {
        echo json_encode([
            'success' => true,
            'message' => 'Unit updated successfully!',
            'unit_id' => $unit_id
        ]);
    } else {
        echo json_encode([
            'success' => false,
            'message' => 'Failed to update unit!',
            'unit_id' => $unit_id
        ]);
    }
} else {
    echo json_encode([
        'success' => false,
        'message' => 'Invalid request!'
    ]);
}
?>

C:\wamp64\www\BookIT\admin\user_management.php
<?php
// users/users.php
include_once __DIR__ . '/../config/db.php';
include_once __DIR__ . '/../includes/session.php';
include_once __DIR__ . '/../includes/functions.php';
checkRole(['admin']);

$message = '';
$error = '';
// Check for session message
if (isset($_SESSION['message'])) {
    $message = $_SESSION['message'];
    unset($_SESSION['message']); // Clear the message after displaying
}

// ==================== LOAD USERS WITH COMPREHENSIVE DATA ====================
$users = [];
try {
    // Search and filter parameters
    $q = isset($_GET['q']) ? trim($_GET['q']) : '';
    $role_filter = isset($_GET['role']) ? $_GET['role'] : 'all';
    $status_filter = isset($_GET['status']) ? $_GET['status'] : 'all';
    
    $where = "WHERE 1=1";
    $params = [];
    
    if ($q !== '') {
        $where .= " AND (u.full_name LIKE ? OR u.email LIKE ? OR u.phone LIKE ?)";
        $search_term = "%$q%";
        array_push($params, $search_term, $search_term, $search_term);
    }
    
    if ($role_filter !== 'all') {
        $where .= " AND u.role = ?";
        $params[] = $role_filter;
    }
    
    if ($status_filter !== 'all') {
        $where .= " AND u.is_active = ?";
        $params[] = ($status_filter === 'active') ? 1 : 0;
    }

    // FIXED SQL QUERY - removed problematic joins
    $sql = "SELECT u.*, 
                   b.branch_name,
                   COUNT(DISTINCT r.reservation_id) AS total_reservations,
                   COUNT(DISTINCT CASE WHEN r.status = 'completed' THEN r.reservation_id END) AS completed_reservations,
                   COUNT(DISTINCT CASE WHEN r.status = 'cancelled' THEN r.reservation_id END) AS cancelled_reservations,
                   COALESCE(SUM(CASE WHEN r.status IN ('completed', 'confirmed') THEN r.total_amount ELSE 0 END), 0) AS total_revenue
            FROM users u
            LEFT JOIN branches b ON u.branch_id = b.branch_id
            LEFT JOIN reservations r ON u.user_id = r.user_id
            $where
            GROUP BY u.user_id
            ORDER BY u.created_at DESC";

    if (!empty($params)) {
        $users = get_multiple_results($sql, $params);
    } else {
        $result = $conn->query($sql);
        if ($result) {
            while ($row = $result->fetch_assoc()) {
                $users[] = $row;
            }
        }
    }

    // Get units count separately for host
    $units_count = [];
    try {
        $units_sql = "SELECT host_id, COUNT(*) as unit_count FROM units GROUP BY host_id";
        $units_result = $conn->query($units_sql);
        if ($units_result) {
            while ($row = $units_result->fetch_assoc()) {
                $units_count[$row['host_id']] = $row['unit_count'];
            }
        }
    } catch (Exception $e) {
        // Ignore if units table doesn't have host_id column
    }

    // Add units count to users data
    foreach ($users as &$user) {
        if ($user['role'] === 'host') {
            $user['total_units'] = $units_count[$user['user_id']] ?? 0;
        } else {
            $user['total_units'] = 0;
        }
    }

} catch (Exception $e) {
    $error = $e->getMessage();
}

// ==================== ADD USER ====================
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['add_user'])) {
    $full_name = sanitize_input($_POST['full_name']);
    $email = sanitize_input($_POST['email']);
    $password = password_hash($_POST['password'], PASSWORD_DEFAULT);
    $role = sanitize_input($_POST['role']);
    $phone = sanitize_input($_POST['phone'] ?? '');
    $branch_id = !empty($_POST['branch_id']) ? (int)$_POST['branch_id'] : null;
    $status = sanitize_input($_POST['status'] ?? 'active');

    // Check if email already exists
    $check_sql = "SELECT user_id FROM users WHERE email = ?";
    $existing_user = get_single_result($check_sql, [$email]);
    
    if ($existing_user) {
        $error = "Email already exists!";
    } else {
        $sql = "INSERT INTO users (full_name, email, password, role, phone, branch_id, is_active) 
                VALUES (?, ?, ?, ?, ?, ?, ?)";
        
        $is_active = ($status === 'active') ? 1 : 0;
        
        if (execute_query($sql, [$full_name, $email, $password, $role, $phone, $branch_id, $is_active])) {
            $message = "User added successfully!";
            // Refresh the page to show new user
            echo "<script>location.reload();</script>";
        } else {
            $error = "Failed to add user!";
        }
    }
}

// ==================== UPDATE USER ====================
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['update_user'])) {
    $user_id = (int)$_POST['user_id'];
    $full_name = sanitize_input($_POST['full_name']);
    $email = sanitize_input($_POST['email']);
    $role = sanitize_input($_POST['role']);
    $phone = sanitize_input($_POST['phone'] ?? '');
    $branch_id = !empty($_POST['branch_id']) ? (int)$_POST['branch_id'] : null;
    $status = sanitize_input($_POST['status'] ?? 'active');

    // Check if email already exists (excluding current user)
    $check_sql = "SELECT user_id FROM users WHERE email = ? AND user_id != ?";
    $existing_user = get_single_result($check_sql, [$email, $user_id]);
    
    if ($existing_user) {
        $error = "Email already exists!";
    } else {
        $sql = "UPDATE users SET full_name = ?, email = ?, role = ?, phone = ?, branch_id = ?, is_active = ? WHERE user_id = ?";
        $is_active = ($status === 'active') ? 1 : 0;
        
        if (execute_query($sql, [$full_name, $email, $role, $phone, $branch_id, $is_active, $user_id])) {
            $message = "User updated successfully!";
            echo "<script>location.reload();</script>";
        } else {
            $error = "Failed to update user!";
        }
    }
}

// ==================== DELETE USER ====================
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['delete_user'])) {
    $user_id = (int)$_POST['user_id'];
    
    $sql = "UPDATE users SET is_active = 0 WHERE user_id = ?";
    if (execute_query($sql, [$user_id])) {
        $message = "User deactivated successfully!";
        echo "<script>location.reload();</script>";
    } else {
        $error = "Failed to deactivate user!";
    }
}

// ==================== RESET PASSWORD ====================
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['reset_password'])) {
    $user_id = (int)$_POST['user_id'];
    $new_password = password_hash('password123', PASSWORD_DEFAULT); // Default reset password
    
    $sql = "UPDATE users SET password = ? WHERE user_id = ?";
    if (execute_query($sql, [$new_password, $user_id])) {
        $message = "Password reset successfully! Default password: password123";
        echo "<script>location.reload();</script>";
    } else {
        $error = "Failed to reset password!";
    }
}

// ==================== SUSPEND USER ====================
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['suspend_user'])) {
    $user_id = (int)$_POST['user_id'];
    
    $sql = "UPDATE users SET is_active = 0 WHERE user_id = ?";
    if (execute_query($sql, [$user_id])) {
        $_SESSION['message'] = "User suspended successfully!";
        header("Location: user_management.php");
        exit();
    } else {
        $error = "Failed to suspend user!";
    }
}

// ==================== ACTIVATE USER ====================
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['activate_user'])) {
    $user_id = (int)$_POST['user_id'];
    
    $sql = "UPDATE users SET is_active = 1 WHERE user_id = ?";
    if (execute_query($sql, [$user_id])) {
        $_SESSION['message'] = "User activated successfully!";
        header("Location: user_management.php");
        exit();
    } else {
        $error = "Failed to activate user!";
    }
}

// Get branches for host assignment
$branches = get_multiple_results("SELECT branch_id, branch_name FROM branches WHERE is_active = 1");

// Calculate statistics
$total_users = count($users);
$admin_count = count(array_filter($users, fn($u) => $u['role'] === 'admin'));
$host_count = count(array_filter($users, fn($u) => $u['role'] === 'host'));
$renter_count = count(array_filter($users, fn($u) => $u['role'] === 'renter'));
$active_users = count(array_filter($users, fn($u) => $u['is_active'] == 1));
$inactive_users = $total_users - $active_users;

// Get last login data separately for users who have it
$last_login_data = [];
try {
    // Check if last_login column exists
    $check_column = $conn->query("SHOW COLUMNS FROM users LIKE 'last_login'");
    if ($check_column->num_rows > 0) {
        $login_sql = "SELECT user_id, last_login FROM users WHERE last_login IS NOT NULL";
        $login_result = $conn->query($login_sql);
        if ($login_result) {
            while ($row = $login_result->fetch_assoc()) {
                $last_login_data[$row['user_id']] = $row['last_login'];
            }
        }
    }
} catch (Exception $e) {
    // Ignore error if last_login column doesn't exist yet
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>User Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/admin/user_management.css" />
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
</head>
<body>
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- =================== BUILT-IN SIDEBAR =================== -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <i class="fas fa-building"></i>
      <span>BookIT Admin</span>
    </div>
        <nav class="sidebar-menu">
            <ul>
                <li><a href="../admin/admin_dashboard.php"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="../admin/manage_branch.php"><i class="fas fa-code-branch"></i><span>Branch Management</span></a></li>
                <li><a href="../admin/user_management.php" class="active"><i class="fas fa-users"></i> <span>User Management</span></a></li>
                <li><a href="../admin/unit_management.php"><i class="fas fa-home"></i> <span>Unit Management</span></a></li>
                <li><a href="../modules/reservations.php"><i class="fas fa-calendar-check"></i> <span>Reservation Management</span></a></li>
                <li><a href="../modules/payment_management.php"><i class="fas fa-credit-card"></i> <span>Payment Management</span></a></li>
                <li><a href="../admin/amenity_management.php"><i class="fas fa-swimming-pool"></i> <span>Amenity Management</span></a></li>
                <li><a href="../admin/reports.php"><i class="fas fa-chart-line"></i> <span>Reports</span></a></li>
                <li><a href="../admin/settings.php"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
            </ul>
        </nav>

    <!-- =================== PROFILE SECTION =================== -->
    <div class="sidebar-profile">
            <div class="profile-info">
                <div class="profile-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="profile-details">
                    <span class="profile-name"><?php echo htmlspecialchars($_SESSION['fullname'] ?? 'Admin'); ?></span>
                    <span class="profile-role"><?php echo htmlspecialchars(ucfirst($_SESSION['role'] ?? 'Admin')); ?></span>
                </div>
            </div>
            <a href="<?php echo SITE_URL; ?>/public/logout.php" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
            </a>
    </div>
  </aside>

<main class="content">
    <div class="page-header">
        <div class="page-title">
            <h1>User Management</h1>
            <p>Manage all users and their roles in the system</p>
        </div>
        <div class="page-actions">
            <button type="button" class="btn-refresh" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button type="button" class="btn-export" onclick="exportUsers('pdf')">
                <i class="fas fa-file-pdf"></i> Export PDF
            </button>
            <button type="button" class="btn-export" onclick="exportUsers('csv')">
                <i class="fas fa-file-csv"></i> Export CSV
            </button>
            <button type="button" class="btn-add" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="fas fa-plus"></i> Add User
            </button>
        </div>
    </div>

    <!-- Messages -->
    <?php if ($message): ?>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> <?php echo $message; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <?php endif; ?>

    <?php if ($error): ?>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> <?php echo $error; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <?php endif; ?>

    <!-- Overview Section -->
    <div class="overview-section">
        <div class="summary-cards">
            <div class="card">
                <div class="card-icon"><i class="fas fa-users"></i></div>
                <div class="card-info">
                    <h3><?= $total_users ?></h3>
                    <p>Total Users</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-user-shield"></i></div>
                <div class="card-info">
                    <h3><?= $admin_count ?></h3>
                    <p>Admins</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-user-tie"></i></div>
                <div class="card-info">
                    <h3><?= $host_count ?></h3>
                    <p>Hosts</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-user"></i></div>
                <div class="card-info">
                    <h3><?= $renter_count ?></h3>
                    <p>Renters</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-user-check"></i></div>
                <div class="card-info">
                    <h3><?= $active_users ?></h3>
                    <p>Active Users</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon"><i class="fas fa-user-slash"></i></div>
                <div class="card-info">
                    <h3><?= $inactive_users ?></h3>
                    <p>Suspended Users</p>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="charts-row">
            <div class="chart-card">
                <div class="chart-header">
                    <h4>User Roles Distribution</h4>
                </div>
                <canvas id="rolesChart"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h4>Account Status</h4>
                </div>
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Search & Filter Section -->
    <div class="filter-section">
        <form method="GET" class="search-form">
            <div class="search-group">
                <input type="text" name="q" placeholder="Search users by name, email or phone" 
                       value="<?= isset($_GET['q']) ? htmlspecialchars($_GET['q']) : '' ?>"
                       class="form-control">
            </div>
            
            <div class="filter-group">
                <select name="role" class="form-select">
                    <option value="all">All Roles</option>
                    <option value="admin" <?= (isset($_GET['role']) && $_GET['role'] === 'admin') ? 'selected' : '' ?>>Admin</option>
                    <option value="host" <?= (isset($_GET['role']) && $_GET['role'] === 'host') ? 'selected' : '' ?>>Host</option>
                    <option value="renter" <?= (isset($_GET['role']) && $_GET['role'] === 'renter') ? 'selected' : '' ?>>Renter</option>
                </select>
            </div>

            <div class="filter-group">
                <select name="status" class="form-select">
                    <option value="all">All Status</option>
                    <option value="active" <?= (isset($_GET['status']) && $_GET['status'] === 'active') ? 'selected' : '' ?>>Active</option>
                    <option value="inactive" <?= (isset($_GET['status']) && $_GET['status'] === 'inactive') ? 'selected' : '' ?>>Suspended</option>
                </select>
            </div>

            <button type="submit" class="btn-search">
                <i class="fas fa-search"></i> Search
            </button>
            <a href="user_management.php" class="btn-clear">Clear Filters</a>
        </form>
    </div>

    <!-- Users Table -->
    <div class="table-card">
        <div class="table-header">
            <div class="table-title">User Details</div>
            <div class="table-info">
                Showing <?= count($users) ?> user(s)
            </div>
        </div>
        <table id="usersTable" class="display table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role</th>
                    <th>Branch</th>
                    <th>Activity</th>
                    <th>Status</th>
                    <th>Registered</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($users as $user): 
                    $last_login = $last_login_data[$user['user_id']] ?? null;
                ?>
                <tr class="<?= $user['is_active'] ? '' : 'suspended-user' ?>" 
                    data-user-id="<?= $user['user_id'] ?>">
                    <td>#U<?= str_pad($user['user_id'], 4, '0', STR_PAD_LEFT) ?></td>
                    <td>
                        <strong><?= htmlspecialchars($user['full_name']) ?></strong>
                    </td>
                    <td><?= htmlspecialchars($user['email']) ?></td>
                    <td><?= htmlspecialchars($user['phone'] ?? 'N/A') ?></td>
                    <td>
                        <span class="badge 
                            <?= $user['role'] === 'admin' ? 'badge-danger' : 
                               ($user['role'] === 'host' ? 'badge-warning' : 'badge-primary') ?>">
                            <?= ucfirst($user['role']) ?>
                        </span>
                    </td>
                    <td><?= htmlspecialchars($user['branch_name'] ?? 'N/A') ?></td>
                    <td>
                        <div class="activity-info">
                            <?php if ($user['role'] === 'renter'): ?>
                                <small><?= $user['total_reservations'] ?> Reservations</small>
                            <?php elseif ($user['role'] === 'host'): ?>
                                <small><?= $user['total_units'] ?> Units</small>
                            <?php else: ?>
                                <small>System Admin</small>
                            <?php endif; ?>
                            <?php if ($last_login): ?>
                                <br><small class="text-muted">Last: <?= date('M d', strtotime($last_login)) ?></small>
                            <?php endif; ?>
                        </div>
                    </td>
                    <td>
                        <span class="badge <?= $user['is_active'] ? 'badge-success' : 'badge-danger' ?>">
                            <?= $user['is_active'] ? 'Active' : 'Suspended' ?>
                        </span>
                    </td>
                    <td><?= date('M d, Y', strtotime($user['created_at'])) ?></td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn-view" 
                                    onclick="viewUser(<?= $user['user_id'] ?>)" 
                                    title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn-edit" 
                                    onclick="editUser(<?= $user['user_id'] ?>)" 
                                    title="Edit User">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn-reset" 
                                    onclick="resetPassword(<?= $user['user_id'] ?>, '<?= htmlspecialchars($user['full_name']) ?>')" 
                                    title="Reset Password">
                                <i class="fas fa-key"></i>
                            </button>
                            <?php if ($user['is_active']): ?>
                                <button type="button" class="btn-suspend" 
                                        onclick="suspendUser(<?= $user['user_id'] ?>, '<?= htmlspecialchars($user['full_name']) ?>')" 
                                        title="Suspend User">
                                    <i class="fas fa-user-slash"></i>
                                </button>
                            <?php else: ?>
                                <button type="button" class="btn-activate" 
                                        onclick="activateUser(<?= $user['user_id'] ?>, '<?= htmlspecialchars($user['full_name']) ?>')" 
                                        title="Activate User">
                                    <i class="fas fa-user-check"></i>
                                </button>
                            <?php endif; ?>
                            <button type="button" class="btn-delete" 
                                    onclick="confirmDelete(<?= $user['user_id'] ?>, '<?= htmlspecialchars($user['full_name']) ?>')" 
                                    title="Delete User">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
</main>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus"></i> Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Full Name *</label>
                                <input type="text" class="form-control" name="full_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Password *</label>
                                <input type="password" class="form-control" name="password" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Phone</label>
                                <input type="text" class="form-control" name="phone">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Role *</label>
                                <select class="form-select" name="role" required onchange="toggleBranchField(this)">
                                    <option value="">Select Role</option>
                                    <option value="admin">Admin</option>
                                    <option value="host">Host</option>
                                    <option value="renter">Renter</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status">
                                    <option value="active">Active</option>
                                    <option value="inactive">Suspended</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3" id="branchField" style="display: none;">
                        <label class="form-label">Branch Assignment (for Hosts)</label>
                        <select class="form-select" name="branch_id">
                            <option value="">Select Branch</option>
                            <?php foreach ($branches as $branch): ?>
                                <option value="<?= $branch['branch_id'] ?>">
                                    <?= htmlspecialchars($branch['branch_name']) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="add_user" class="btn btn-primary">
                        <i class="fas fa-save"></i> Add User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST">
                <input type="hidden" name="user_id" id="edit_user_id">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="editUserForm">
                    <!-- Form will be loaded via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="update_user" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View User Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user"></i> User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewUserDetails">
                <!-- Details will be loaded via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST">
                <input type="hidden" name="user_id" id="delete_user_id">
                <div class="modal-header">
                    <h5 class="modal-title text-danger"><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to permanently delete this user?</p>
                    <p><strong>User:</strong> <span id="delete_user_name"></span></p>
                    <p class="text-muted">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="delete_user" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Required Scripts -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

<script>
    // Chart Data
    const rolesData = {
        admin: <?= $admin_count ?>,
        host: <?= $host_count ?>,
        renter: <?= $renter_count ?>
    };

    const statusData = {
        active: <?= $active_users ?>,
        inactive: <?= $inactive_users ?>
    };

    // Branches data for JavaScript
    const branches = <?= json_encode($branches) ?>;
</script>

<script src="../assets/js/admin/user_management.js"></script>
</body>
</html>


